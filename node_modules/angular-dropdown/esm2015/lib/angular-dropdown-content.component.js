/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { Component, Input, Host, Inject, forwardRef, NgZone } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { AngularDropdownDirective } from './angular-dropdown.directive';
import { closest, waitForAnimation } from './utils';
/** @type {?} */
const MutationObserver = ((/** @type {?} */ (window))).MutationObserver;
export class AngularDropdownContentComponent {
    /**
     * @param {?} dropdown
     * @param {?} zone
     * @param {?} document
     */
    constructor(dropdown, zone, document) {
        this.dropdown = dropdown;
        this.zone = zone;
        this.dropdownClass = '';
        this.overlay = false;
        this.hasMoved = false;
        this._animationClass = null;
        this.isTouchDevice = 'ontouchstart' in window;
        this.mutationObserver = null;
        this.destroy$ = new Subject();
        this.transitioningInClass = 'ng-dropdown-content--transitioning-in';
        this.transitionedInClass = 'ng-dropdown-content--transitioned-in';
        this.transitioningOutClass = 'ng-dropdown-content--transitioning-out';
        this.shouldOpen = false;
        this.repositionInZone = () => this.zone.run(() => this.dropdown.reposition());
        this.handleRootMouseDown = (e) => {
            const { target } = (/** @type {?} */ (e));
            if (this.hasMoved ||
                (this.dropdownElement !== null &&
                    this.dropdownElement.contains(target)) ||
                (this.triggerElement !== null && this.triggerElement.contains(target))) {
                this.hasMoved = false;
                return;
            }
            /** @type {?} */
            const closestDropdown = closest(target, 'ng-dropdown-content');
            if (closestDropdown !== null) {
                /** @type {?} */
                const trigger = this.document.querySelector(`[aria-controls=${closestDropdown.getAttribute('id')}]`);
                /** @type {?} */
                const parentDropdown = closest((/** @type {?} */ (trigger)), 'ng-dropdown-content');
                if (parentDropdown !== null &&
                    parentDropdown.getAttribute('id') === this.dropdown.dropdownId) {
                    this.hasMoved = false;
                    return;
                }
            }
            this.dropdown.close(true);
        };
        this.touchStartHandler = (e) => {
            this.document.body.addEventListener('touchmove', this.touchMoveHandler, true);
        };
        this.touchMoveHandler = (e) => {
            this.hasMoved = true;
            this.document.body.removeEventListener('touchmove', this.touchMoveHandler, true);
        };
        this.document = document;
    }
    /**
     * @return {?}
     */
    get dropdownElement() {
        return this.dropdown.dropdownElement;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.dropdown.onOpen
            .pipe(takeUntil(this.destroy$))
            .subscribe(() => (this.shouldOpen = true));
        this.dropdown.onClose
            .pipe(takeUntil(this.destroy$))
            .subscribe(() => this.close());
    }
    /**
     * @param {?} className
     * @return {?}
     */
    set animationClass(className) {
        if (this.dropdownElement !== null) {
            if (this._animationClass && className !== this._animationClass) {
                this.dropdownElement.classList.remove(this._animationClass);
            }
            else if (className) {
                this.dropdownElement.classList.add(className);
            }
        }
        this._animationClass = className;
    }
    /**
     * @return {?}
     */
    get animationClass() {
        return this._animationClass;
    }
    /**
     * @return {?}
     */
    get triggerElement() {
        return this.dropdown.triggerElement;
    }
    /**
     * @return {?}
     */
    ngAfterViewChecked() {
        if (this.shouldOpen) {
            this.animationClass = this.transitioningInClass;
            requestAnimationFrame(() => this.open());
            this.shouldOpen = false;
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy$.next();
        this.teardownEvents();
    }
    /**
     * @return {?}
     */
    open() {
        this.document.body.addEventListener('mousedown', this.handleRootMouseDown, true);
        if (this.isTouchDevice) {
            this.document.body.addEventListener('touchstart', this.touchStartHandler, true);
            this.document.body.addEventListener('touchend', this.handleRootMouseDown, true);
        }
        /** @type {?} */
        const changes = this.dropdown.reposition();
        if (!this.dropdown.renderInPlace) {
            this.addGlobalEvents();
            this.startObservingDomMutations();
        }
        else if (changes !== null && changes.vPosition === 'above') {
            this.startObservingDomMutations();
        }
        requestAnimationFrame(() => this.animateIn());
    }
    /**
     * @return {?}
     */
    close() {
        this.teardownEvents();
        this.animateOut();
    }
    /**
     * @return {?}
     */
    animateIn() {
        waitForAnimation(this.dropdownElement, () => {
            this.animationClass = this.transitionedInClass;
        });
    }
    /**
     * @return {?}
     */
    animateOut() {
        if (this.dropdownElement === null) {
            return;
        }
        /** @type {?} */
        const parentElement = this.dropdown.renderInPlace
            ? (/** @type {?} */ ((/** @type {?} */ (this.dropdownElement.parentElement)).parentElement))
            : (/** @type {?} */ (this.dropdownElement.parentElement));
        /** @type {?} */
        const clone = (/** @type {?} */ (this.dropdownElement.cloneNode(true)));
        clone.id = `${this.dropdownElement.id}--clone`;
        clone.classList.remove(this.transitionedInClass);
        clone.classList.remove(this.transitioningInClass);
        clone.classList.add(this.transitioningOutClass);
        parentElement.appendChild(clone);
        this.animationClass = this.transitioningInClass;
        waitForAnimation(clone, () => parentElement.removeChild(clone));
    }
    /**
     * @return {?}
     */
    startObservingDomMutations() {
        if (MutationObserver !== undefined) {
            this.mutationObserver = new MutationObserver((mutations) => {
                if (mutations[0].addedNodes.length ||
                    mutations[0].removedNodes.length) {
                    this.repositionInZone();
                }
            });
            (/** @type {?} */ (this.mutationObserver)).observe((/** @type {?} */ (this.dropdownElement)), {
                childList: true,
                subtree: true
            });
        }
        else {
            (/** @type {?} */ (this.dropdownElement)).addEventListener('DOMNodeInserted', this.repositionInZone, false);
            (/** @type {?} */ (this.dropdownElement)).addEventListener('DOMNodeRemoved', this.repositionInZone, false);
        }
    }
    /**
     * @return {?}
     */
    stopObservingDomMutations() {
        if (MutationObserver) {
            if (this.mutationObserver) {
                this.mutationObserver.disconnect();
                this.mutationObserver = null;
            }
        }
        else {
            if (this.dropdownElement !== null) {
                this.dropdownElement.removeEventListener('DOMNodeInserted', this.repositionInZone);
                this.dropdownElement.removeEventListener('DOMNodeRemoved', this.repositionInZone);
            }
        }
    }
    /**
     * @return {?}
     */
    addGlobalEvents() {
        window.addEventListener('scroll', this.repositionInZone);
        window.addEventListener('resize', this.repositionInZone);
        window.addEventListener('orientationchange', this.repositionInZone);
    }
    /**
     * @return {?}
     */
    removeGlobalEvents() {
        window.removeEventListener('scroll', this.repositionInZone);
        window.removeEventListener('resize', this.repositionInZone);
        window.removeEventListener('orientationchange', this.repositionInZone);
    }
    /**
     * @return {?}
     */
    teardownEvents() {
        this.removeGlobalEvents();
        this.stopObservingDomMutations();
        this.document.body.removeEventListener('mousedown', this.handleRootMouseDown, true);
        if (this.isTouchDevice) {
            this.document.body.removeEventListener('touchstart', this.touchStartHandler, true);
            this.document.body.removeEventListener('touchend', this.handleRootMouseDown, true);
        }
    }
}
AngularDropdownContentComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-dropdown-content,[ng-dropdown-content],[ngDropdownContent]',
                template: "<ng-container *ngIf=\"dropdown.isOpen$ | async as isOpen\">\n  <ng-container *ngWormhole=\"'#ng-dropdown-outlet'; renderInPlace: dropdown.renderInPlace\">\n    <div *ngIf=\"overlay && isOpen\" class=\"ng-dropdown-overlay\"></div>\n    <div [id]=\"dropdown.dropdownId\"\n        class=\"ng-dropdown-content {{dropdownClass}}\"\n        [style.top]=\"(dropdown.position$ | async)?.top\"\n        [style.right]=\"(dropdown.position$ | async)?.right\"\n        [style.bottom]=\"(dropdown.position$ | async)?.bottom\"\n        [style.left]=\"(dropdown.position$ | async)?.left\"\n        [class.render-in-place]=\"dropdown.renderInPlace\"\n        [class.ng-dropdown-content--above]=\"(dropdown.position$ | async)?.vPosition === 'above'\"\n        [class.ng-dropdown-content--below]=\"(dropdown.position$ | async)?.vPosition === 'below'\"\n        [class.ng-dropdown-content--right]=\"(dropdown.position$ | async)?.hPosition === 'right'\"\n        [class.ng-dropdown-content--center]=\"(dropdown.position$ | async)?.hPosition === 'center'\"\n        [class.ng-dropdown-content--left]=\"(dropdown.position$ | async)?.hPosition === 'left'\">\n      <ng-content></ng-content>\n    </div>\n  </ng-container>\n  <div *ngIf=\"!isOpen\" [id]=\"dropdown.dropdownId\" class=\"ng-dropdown-placeholder\"></div>\n</ng-container>\n",
                host: {
                    '[class.render-in-place]': 'dropdown.renderInPlace'
                },
                styles: [":host{display:none}:host.render-in-place{display:block;position:absolute}"]
            }] }
];
AngularDropdownContentComponent.ctorParameters = () => [
    { type: AngularDropdownDirective, decorators: [{ type: Host }, { type: Inject, args: [forwardRef(() => AngularDropdownDirective),] }] },
    { type: NgZone },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
AngularDropdownContentComponent.propDecorators = {
    dropdownClass: [{ type: Input }],
    overlay: [{ type: Input }],
    transitioningInClass: [{ type: Input }],
    transitionedInClass: [{ type: Input }],
    transitioningOutClass: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    AngularDropdownContentComponent.prototype.dropdownClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.overlay;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.hasMoved;
    /** @type {?} */
    AngularDropdownContentComponent.prototype._animationClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.isTouchDevice;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.mutationObserver;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.destroy$;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.transitioningInClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.transitionedInClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.transitioningOutClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.shouldOpen;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.document;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.repositionInZone;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.handleRootMouseDown;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.touchStartHandler;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.touchMoveHandler;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.dropdown;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1kcm9wZG93bi1jb250ZW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItZHJvcGRvd24vIiwic291cmNlcyI6WyJsaWIvYW5ndWxhci1kcm9wZG93bi1jb250ZW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0MsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsSUFBSSxFQUNKLE1BQU0sRUFDTixVQUFVLEVBSVYsTUFBTSxFQUNQLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUzQyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sU0FBUyxDQUFDOztNQUU5QyxnQkFBZ0IsR0FBRyxDQUFDLG1CQUFBLE1BQU0sRUFBTyxDQUFDLENBQUMsZ0JBQWdCO0FBVXpELE1BQU07Ozs7OztJQTRCSixZQUdTLFFBQWtDLEVBQ2pDLElBQVksRUFDRixRQUFhO1FBRnhCLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQ2pDLFNBQUksR0FBSixJQUFJLENBQVE7UUE3QnRCLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBR25CLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFFUixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLG9CQUFlLEdBQWtCLElBQUksQ0FBQztRQUN0QyxrQkFBYSxHQUFZLGNBQWMsSUFBSSxNQUFNLENBQUM7UUFDbEQscUJBQWdCLEdBQTRCLElBQUksQ0FBQztRQUNqRCxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUd2Qyx5QkFBb0IsR0FBRyx1Q0FBdUMsQ0FBQztR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NENBbURILE1BQU0sU0FBQyxRQUFROzs7NEJBL0JqQixLQUFLO3NCQUdMLEtBQUs7bUNBU0wsS0FBSztrQ0FFTCxLQUFLO29DQUVMLEtBQUs7Ozs7SUFoQk4sd0RBQ21COztJQUVuQixrREFDZ0I7O0lBRWhCLG1EQUF5Qjs7SUFDekIsMERBQThDOztJQUM5Qyx3REFBMEQ7O0lBQzFELDJEQUF5RDs7SUFDekQsbURBQXVDOztJQUV2QywrREFDK0Q7O0lBQy9ELDhEQUM2RDs7SUFDN0QsZ0VBQ2lFOztJQU1qRSxxREFBMkI7O0lBQzNCLG1EQUEyQjs7SUEwRjNCLDJEQUNrRDs7SUEwQmxELDhEQTZCRTs7SUE4REYsNERBTUU7O0lBRUYsMkRBT0U7O0lBNU5BLG1EQUV5Qzs7SUFDekMsK0NBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBIb3N0LFxuICBJbmplY3QsXG4gIGZvcndhcmRSZWYsXG4gIEFmdGVyVmlld0NoZWNrZWQsXG4gIE9uSW5pdCxcbiAgT25EZXN0cm95LFxuICBOZ1pvbmVcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuaW1wb3J0IHsgQW5ndWxhckRyb3Bkb3duRGlyZWN0aXZlIH0gZnJvbSAnLi9hbmd1bGFyLWRyb3Bkb3duLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBjbG9zZXN0LCB3YWl0Rm9yQW5pbWF0aW9uIH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IE11dGF0aW9uT2JzZXJ2ZXIgPSAod2luZG93IGFzIGFueSkuTXV0YXRpb25PYnNlcnZlcjtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmctZHJvcGRvd24tY29udGVudCxbbmctZHJvcGRvd24tY29udGVudF0sW25nRHJvcGRvd25Db250ZW50XScsXG4gIHRlbXBsYXRlVXJsOiAnLi9hbmd1bGFyLWRyb3Bkb3duLWNvbnRlbnQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9hbmd1bGFyLWRyb3Bkb3duLWNvbnRlbnQuY29tcG9uZW50LmNzcyddLFxuICBob3N0OiB7XG4gICAgJ1tjbGFzcy5yZW5kZXItaW4tcGxhY2VdJzogJ2Ryb3Bkb3duLnJlbmRlckluUGxhY2UnXG4gIH1cbn0pXG5leHBvcnQgY2xhc3MgQW5ndWxhckRyb3Bkb3duQ29udGVudENvbXBvbmVudFxuICBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3Q2hlY2tlZCwgT25EZXN0cm95IHtcbiAgQElucHV0KClcbiAgZHJvcGRvd25DbGFzcyA9ICcnO1xuXG4gIEBJbnB1dCgpXG4gIG92ZXJsYXkgPSBmYWxzZTtcblxuICBwcml2YXRlIGhhc01vdmVkID0gZmFsc2U7XG4gIHByaXZhdGUgX2FuaW1hdGlvbkNsYXNzOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBpc1RvdWNoRGV2aWNlOiBib29sZWFuID0gJ29udG91Y2hzdGFydCcgaW4gd2luZG93O1xuICBwcml2YXRlIG11dGF0aW9uT2JzZXJ2ZXI6IE11dGF0aW9uT2JzZXJ2ZXIgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgQElucHV0KClcbiAgdHJhbnNpdGlvbmluZ0luQ2xhc3MgPSAnbmctZHJvcGRvd24tY29udGVudC0tdHJhbnNpdGlvbmluZy1pbic7XG4gIEBJbnB1dCgpXG4gIHRyYW5zaXRpb25lZEluQ2xhc3MgPSAnbmctZHJvcGRvd24tY29udGVudC0tdHJhbnNpdGlvbmVkLWluJztcbiAgQElucHV0KClcbiAgdHJhbnNpdGlvbmluZ091dENsYXNzID0gJ25nLWRyb3Bkb3duLWNvbnRlbnQtLXRyYW5zaXRpb25pbmctb3V0JztcblxuICBwcml2YXRlIGdldCBkcm9wZG93bkVsZW1lbnQoKTogSFRNTEVsZW1lbnQgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5kcm9wZG93bi5kcm9wZG93bkVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIHNob3VsZE9wZW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBkb2N1bWVudDogRG9jdW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEhvc3QoKVxuICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBBbmd1bGFyRHJvcGRvd25EaXJlY3RpdmUpKVxuICAgIHB1YmxpYyBkcm9wZG93bjogQW5ndWxhckRyb3Bkb3duRGlyZWN0aXZlLFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIGRvY3VtZW50OiBhbnlcbiAgKSB7XG4gICAgdGhpcy5kb2N1bWVudCA9IGRvY3VtZW50O1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5kcm9wZG93bi5vbk9wZW5cbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4gKHRoaXMuc2hvdWxkT3BlbiA9IHRydWUpKTtcblxuICAgIHRoaXMuZHJvcGRvd24ub25DbG9zZVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLmNsb3NlKCkpO1xuICB9XG5cbiAgc2V0IGFuaW1hdGlvbkNsYXNzKGNsYXNzTmFtZTogc3RyaW5nIHwgbnVsbCkge1xuICAgIGlmICh0aGlzLmRyb3Bkb3duRWxlbWVudCAhPT0gbnVsbCkge1xuICAgICAgaWYgKHRoaXMuX2FuaW1hdGlvbkNsYXNzICYmIGNsYXNzTmFtZSAhPT0gdGhpcy5fYW5pbWF0aW9uQ2xhc3MpIHtcbiAgICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSh0aGlzLl9hbmltYXRpb25DbGFzcyk7XG4gICAgICB9IGVsc2UgaWYgKGNsYXNzTmFtZSkge1xuICAgICAgICB0aGlzLmRyb3Bkb3duRWxlbWVudC5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2FuaW1hdGlvbkNsYXNzID0gY2xhc3NOYW1lO1xuICB9XG5cbiAgZ2V0IGFuaW1hdGlvbkNsYXNzKCk6IHN0cmluZyB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLl9hbmltYXRpb25DbGFzcztcbiAgfVxuXG4gIGdldCB0cmlnZ2VyRWxlbWVudCgpOiBFbGVtZW50IHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuZHJvcGRvd24udHJpZ2dlckVsZW1lbnQ7XG4gIH1cblxuICBuZ0FmdGVyVmlld0NoZWNrZWQoKSB7XG4gICAgaWYgKHRoaXMuc2hvdWxkT3Blbikge1xuICAgICAgdGhpcy5hbmltYXRpb25DbGFzcyA9IHRoaXMudHJhbnNpdGlvbmluZ0luQ2xhc3M7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5vcGVuKCkpO1xuICAgICAgdGhpcy5zaG91bGRPcGVuID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy50ZWFyZG93bkV2ZW50cygpO1xuICB9XG5cbiAgb3BlbigpOiB2b2lkIHtcbiAgICB0aGlzLmRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICdtb3VzZWRvd24nLFxuICAgICAgdGhpcy5oYW5kbGVSb290TW91c2VEb3duLFxuICAgICAgdHJ1ZVxuICAgICk7XG5cbiAgICBpZiAodGhpcy5pc1RvdWNoRGV2aWNlKSB7XG4gICAgICB0aGlzLmRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgJ3RvdWNoc3RhcnQnLFxuICAgICAgICB0aGlzLnRvdWNoU3RhcnRIYW5kbGVyLFxuICAgICAgICB0cnVlXG4gICAgICApO1xuICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICd0b3VjaGVuZCcsXG4gICAgICAgIHRoaXMuaGFuZGxlUm9vdE1vdXNlRG93bixcbiAgICAgICAgdHJ1ZVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5kcm9wZG93bi5yZXBvc2l0aW9uKCk7XG4gICAgaWYgKCF0aGlzLmRyb3Bkb3duLnJlbmRlckluUGxhY2UpIHtcbiAgICAgIHRoaXMuYWRkR2xvYmFsRXZlbnRzKCk7XG4gICAgICB0aGlzLnN0YXJ0T2JzZXJ2aW5nRG9tTXV0YXRpb25zKCk7XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VzICE9PSBudWxsICYmIGNoYW5nZXMudlBvc2l0aW9uID09PSAnYWJvdmUnKSB7XG4gICAgICB0aGlzLnN0YXJ0T2JzZXJ2aW5nRG9tTXV0YXRpb25zKCk7XG4gICAgfVxuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMuYW5pbWF0ZUluKCkpO1xuICB9XG5cbiAgY2xvc2UoKTogdm9pZCB7XG4gICAgdGhpcy50ZWFyZG93bkV2ZW50cygpO1xuICAgIHRoaXMuYW5pbWF0ZU91dCgpO1xuICB9XG5cbiAgcHJpdmF0ZSByZXBvc2l0aW9uSW5ab25lID0gKCkgPT5cbiAgICB0aGlzLnpvbmUucnVuKCgpID0+IHRoaXMuZHJvcGRvd24ucmVwb3NpdGlvbigpKTtcblxuICBwcml2YXRlIGFuaW1hdGVJbigpOiB2b2lkIHtcbiAgICB3YWl0Rm9yQW5pbWF0aW9uKHRoaXMuZHJvcGRvd25FbGVtZW50LCAoKSA9PiB7XG4gICAgICB0aGlzLmFuaW1hdGlvbkNsYXNzID0gdGhpcy50cmFuc2l0aW9uZWRJbkNsYXNzO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhbmltYXRlT3V0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmRyb3Bkb3duRWxlbWVudCA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSB0aGlzLmRyb3Bkb3duLnJlbmRlckluUGxhY2VcbiAgICAgID8gdGhpcy5kcm9wZG93bkVsZW1lbnQucGFyZW50RWxlbWVudCEucGFyZW50RWxlbWVudCFcbiAgICAgIDogdGhpcy5kcm9wZG93bkVsZW1lbnQucGFyZW50RWxlbWVudCE7XG4gICAgY29uc3QgY2xvbmUgPSB0aGlzLmRyb3Bkb3duRWxlbWVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgSFRNTEVsZW1lbnQ7XG4gICAgY2xvbmUuaWQgPSBgJHt0aGlzLmRyb3Bkb3duRWxlbWVudC5pZH0tLWNsb25lYDtcbiAgICBjbG9uZS5jbGFzc0xpc3QucmVtb3ZlKHRoaXMudHJhbnNpdGlvbmVkSW5DbGFzcyk7XG4gICAgY2xvbmUuY2xhc3NMaXN0LnJlbW92ZSh0aGlzLnRyYW5zaXRpb25pbmdJbkNsYXNzKTtcbiAgICBjbG9uZS5jbGFzc0xpc3QuYWRkKHRoaXMudHJhbnNpdGlvbmluZ091dENsYXNzKTtcbiAgICBwYXJlbnRFbGVtZW50LmFwcGVuZENoaWxkKGNsb25lKTtcbiAgICB0aGlzLmFuaW1hdGlvbkNsYXNzID0gdGhpcy50cmFuc2l0aW9uaW5nSW5DbGFzcztcbiAgICB3YWl0Rm9yQW5pbWF0aW9uKGNsb25lLCAoKSA9PiBwYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGNsb25lKSk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVJvb3RNb3VzZURvd24gPSAoZTogRXZlbnQpOiB2b2lkID0+IHtcbiAgICBjb25zdCB7IHRhcmdldCB9ID0gZSBhcyBFdmVudCAmIHsgdGFyZ2V0OiBFbGVtZW50IH07XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLmhhc01vdmVkIHx8XG4gICAgICAodGhpcy5kcm9wZG93bkVsZW1lbnQgIT09IG51bGwgJiZcbiAgICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQuY29udGFpbnModGFyZ2V0KSkgfHxcbiAgICAgICh0aGlzLnRyaWdnZXJFbGVtZW50ICE9PSBudWxsICYmIHRoaXMudHJpZ2dlckVsZW1lbnQuY29udGFpbnModGFyZ2V0KSlcbiAgICApIHtcbiAgICAgIHRoaXMuaGFzTW92ZWQgPSBmYWxzZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjbG9zZXN0RHJvcGRvd24gPSBjbG9zZXN0KHRhcmdldCwgJ25nLWRyb3Bkb3duLWNvbnRlbnQnKTtcbiAgICBpZiAoY2xvc2VzdERyb3Bkb3duICE9PSBudWxsKSB7XG4gICAgICBjb25zdCB0cmlnZ2VyID0gdGhpcy5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgICBgW2FyaWEtY29udHJvbHM9JHtjbG9zZXN0RHJvcGRvd24uZ2V0QXR0cmlidXRlKCdpZCcpfV1gXG4gICAgICApO1xuICAgICAgY29uc3QgcGFyZW50RHJvcGRvd24gPSBjbG9zZXN0KHRyaWdnZXIhLCAnbmctZHJvcGRvd24tY29udGVudCcpO1xuICAgICAgaWYgKFxuICAgICAgICBwYXJlbnREcm9wZG93biAhPT0gbnVsbCAmJlxuICAgICAgICBwYXJlbnREcm9wZG93bi5nZXRBdHRyaWJ1dGUoJ2lkJykgPT09IHRoaXMuZHJvcGRvd24uZHJvcGRvd25JZFxuICAgICAgKSB7XG4gICAgICAgIHRoaXMuaGFzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuZHJvcGRvd24uY2xvc2UodHJ1ZSk7XG4gIH07XG5cbiAgcHJpdmF0ZSBzdGFydE9ic2VydmluZ0RvbU11dGF0aW9ucygpOiB2b2lkIHtcbiAgICBpZiAoTXV0YXRpb25PYnNlcnZlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLm11dGF0aW9uT2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigobXV0YXRpb25zOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIG11dGF0aW9uc1swXS5hZGRlZE5vZGVzLmxlbmd0aCB8fFxuICAgICAgICAgIG11dGF0aW9uc1swXS5yZW1vdmVkTm9kZXMubGVuZ3RoXG4gICAgICAgICkge1xuICAgICAgICAgIHRoaXMucmVwb3NpdGlvbkluWm9uZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMubXV0YXRpb25PYnNlcnZlciEub2JzZXJ2ZSh0aGlzLmRyb3Bkb3duRWxlbWVudCEsIHtcbiAgICAgICAgY2hpbGRMaXN0OiB0cnVlLFxuICAgICAgICBzdWJ0cmVlOiB0cnVlXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQhLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICdET01Ob2RlSW5zZXJ0ZWQnLFxuICAgICAgICB0aGlzLnJlcG9zaXRpb25JblpvbmUsXG4gICAgICAgIGZhbHNlXG4gICAgICApO1xuICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQhLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICdET01Ob2RlUmVtb3ZlZCcsXG4gICAgICAgIHRoaXMucmVwb3NpdGlvbkluWm9uZSxcbiAgICAgICAgZmFsc2VcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdG9wT2JzZXJ2aW5nRG9tTXV0YXRpb25zKCk6IHZvaWQge1xuICAgIGlmIChNdXRhdGlvbk9ic2VydmVyKSB7XG4gICAgICBpZiAodGhpcy5tdXRhdGlvbk9ic2VydmVyKSB7XG4gICAgICAgIHRoaXMubXV0YXRpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgICAgIHRoaXMubXV0YXRpb25PYnNlcnZlciA9IG51bGw7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLmRyb3Bkb3duRWxlbWVudCAhPT0gbnVsbCkge1xuICAgICAgICB0aGlzLmRyb3Bkb3duRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgICAgICdET01Ob2RlSW5zZXJ0ZWQnLFxuICAgICAgICAgIHRoaXMucmVwb3NpdGlvbkluWm9uZVxuICAgICAgICApO1xuICAgICAgICB0aGlzLmRyb3Bkb3duRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgICAgICdET01Ob2RlUmVtb3ZlZCcsXG4gICAgICAgICAgdGhpcy5yZXBvc2l0aW9uSW5ab25lXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRHbG9iYWxFdmVudHMoKTogdm9pZCB7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMucmVwb3NpdGlvbkluWm9uZSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMucmVwb3NpdGlvbkluWm9uZSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywgdGhpcy5yZXBvc2l0aW9uSW5ab25lKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlR2xvYmFsRXZlbnRzKCk6IHZvaWQge1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLnJlcG9zaXRpb25JblpvbmUpO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLnJlcG9zaXRpb25JblpvbmUpO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIHRoaXMucmVwb3NpdGlvbkluWm9uZSk7XG4gIH1cblxuICBwcml2YXRlIHRvdWNoU3RhcnRIYW5kbGVyID0gKGU6IEV2ZW50KSA9PiB7XG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAndG91Y2htb3ZlJyxcbiAgICAgIHRoaXMudG91Y2hNb3ZlSGFuZGxlcixcbiAgICAgIHRydWVcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgdG91Y2hNb3ZlSGFuZGxlciA9IChlOiBFdmVudCkgPT4ge1xuICAgIHRoaXMuaGFzTW92ZWQgPSB0cnVlO1xuICAgIHRoaXMuZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgJ3RvdWNobW92ZScsXG4gICAgICB0aGlzLnRvdWNoTW92ZUhhbmRsZXIsXG4gICAgICB0cnVlXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIHRlYXJkb3duRXZlbnRzKCkge1xuICAgIHRoaXMucmVtb3ZlR2xvYmFsRXZlbnRzKCk7XG4gICAgdGhpcy5zdG9wT2JzZXJ2aW5nRG9tTXV0YXRpb25zKCk7XG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAnbW91c2Vkb3duJyxcbiAgICAgIHRoaXMuaGFuZGxlUm9vdE1vdXNlRG93bixcbiAgICAgIHRydWVcbiAgICApO1xuXG4gICAgaWYgKHRoaXMuaXNUb3VjaERldmljZSkge1xuICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAgICd0b3VjaHN0YXJ0JyxcbiAgICAgICAgdGhpcy50b3VjaFN0YXJ0SGFuZGxlcixcbiAgICAgICAgdHJ1ZVxuICAgICAgKTtcbiAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgICAndG91Y2hlbmQnLFxuICAgICAgICB0aGlzLmhhbmRsZVJvb3RNb3VzZURvd24sXG4gICAgICAgIHRydWVcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXX0=