/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Observable, BehaviorSubject, of } from 'rxjs';
import { skip, first, filter } from 'rxjs/operators';
import { Directive, Attribute, Inject, Input, Output, ContentChild, forwardRef } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { AngularDropdownControlDirective } from './angular-dropdown-control.directive';
import { AngularDropdownContentComponent } from './angular-dropdown-content.component';
import { calculatePosition, calculateInPlacePosition } from './utils';
/**
 * @record
 */
export function AngularDropdownPositionChanges() { }
if (false) {
    /** @type {?} */
    AngularDropdownPositionChanges.prototype.vPosition;
    /** @type {?} */
    AngularDropdownPositionChanges.prototype.hPosition;
}
/** @type {?} */
let _id = 1;
/**
 * @return {?}
 */
function generateDropdownId() {
    return _id++;
}
/**
 * @record
 */
export function DropdownContentPosition() { }
if (false) {
    /** @type {?} */
    DropdownContentPosition.prototype.hPosition;
    /** @type {?} */
    DropdownContentPosition.prototype.vPosition;
    /** @type {?} */
    DropdownContentPosition.prototype.top;
    /** @type {?} */
    DropdownContentPosition.prototype.left;
    /** @type {?} */
    DropdownContentPosition.prototype.bottom;
    /** @type {?} */
    DropdownContentPosition.prototype.right;
}
/** @type {?} */
const EmptyDropdownContentPosition = Object.freeze({
    vPosition: null,
    hPosition: null,
    top: null,
    left: null,
    bottom: null,
    right: null
});
export class AngularDropdownDirective {
    /**
     * @param {?} document
     * @param {?=} id
     */
    constructor(document, id) {
        this.renderInPlace = false;
        this.control = null;
        this.previousVerticalPosition = null;
        this.previousHorizontalPosition = null;
        this.matchTriggerWidth = false;
        this._isOpen$ = new BehaviorSubject(false);
        this.isOpen$ = this._isOpen$.pipe(skip(1));
        this.position$ = new BehaviorSubject(EmptyDropdownContentPosition);
        this.calculatePosition = calculatePosition;
        this.calculateInPlacePosition = calculateInPlacePosition;
        this.disabled = false;
        this.beforeOpen = null;
        this.beforeClose = null;
        this.verticalPosition = 'auto';
        this.horizontalPosition = 'auto';
        this.onOpen = this.isOpen$.pipe(filter(open => open === true));
        this.onClose = this.isOpen$.pipe(filter(open => open === false));
        this.uniqueId = null;
        this.width = null;
        this.reposition = () => {
            if (!this._isOpen$.getValue()) {
                return null;
            }
            /** @type {?} */
            const dropdownElement = this.dropdownElement;
            if (!dropdownElement || !this.triggerElement) {
                return null;
            }
            /** @type {?} */
            const _calculatePosition = this.renderInPlace
                ? this.calculateInPlacePosition
                : this.calculatePosition;
            /** @type {?} */
            const options = {
                horizontalPosition: this.horizontalPosition,
                verticalPosition: this.verticalPosition,
                matchTriggerWidth: this.matchTriggerWidth,
                previousHorizontalPosition: this.previousHorizontalPosition,
                previousVerticalPosition: this.previousVerticalPosition
            };
            /** @type {?} */
            const positionData = _calculatePosition(this.triggerElement, dropdownElement, options);
            return this.applyReposition(this.triggerElement, dropdownElement, positionData);
        };
        this.document = document;
        this.initializeId(id);
        this.createDefaultWormholeOutlet();
    }
    /**
     * @return {?}
     */
    get dropdownId() {
        return `ng-dropdown-content-${this.uniqueId}`;
    }
    /**
     * @return {?}
     */
    get triggerElement() {
        return this.control && this.control.element.nativeElement;
    }
    /**
     * @return {?}
     */
    get dropdownElement() {
        return this.document.getElementById(this.dropdownId);
    }
    /**
     * @param {?} __0
     * @return {?}
     */
    ngOnChanges({ disabled }) {
        if (disabled &&
            disabled.firstChange === false &&
            disabled.currentValue === true &&
            disabled.previousValue !== true) {
            this.disable();
        }
    }
    /**
     * @return {?}
     */
    open() {
        if (this.disabled || this._isOpen$.getValue()) {
            return;
        }
        /** @type {?} */
        let open$ = of(true);
        if (this.beforeOpen) {
            /** @type {?} */
            const result = this.beforeOpen();
            open$ = result instanceof Observable ? result : of(result);
        }
        open$
            .pipe(first(), filter(open => open === true))
            .subscribe(() => this._isOpen$.next(true));
    }
    /**
     * @param {?=} skipFocus
     * @return {?}
     */
    close(skipFocus = false) {
        if (this.disabled || !this._isOpen$.getValue()) {
            return;
        }
        /** @type {?} */
        let close$ = of(true);
        if (this.beforeClose) {
            /** @type {?} */
            const result = this.beforeClose();
            close$ = result instanceof Observable ? result : of(result);
        }
        close$
            .pipe(first(), filter(close => close === true))
            .subscribe(() => {
            Object.assign(this, {
                hPosition: null,
                vPosition: null,
                top: null,
                right: null,
                bottom: null,
                left: null,
                width: null,
                previousVerticalPosition: null,
                previousHorizontalPosition: null
            });
            this._isOpen$.next(false);
            if (!skipFocus) {
                if (this.triggerElement instanceof HTMLElement &&
                    this.triggerElement.tabIndex > -1) {
                    this.triggerElement.focus();
                }
            }
        });
    }
    /**
     * @return {?}
     */
    toggle() {
        if (this._isOpen$.getValue()) {
            this.close();
        }
        else {
            this.open();
        }
    }
    /**
     * @return {?}
     */
    disable() {
        this.disabled = true;
        this.close();
    }
    /**
     * @return {?}
     */
    enable() {
        this.disabled = false;
    }
    /**
     * @param {?} trigger
     * @param {?} dropdown
     * @param {?} positions
     * @return {?}
     */
    applyReposition(trigger, dropdown, positions) {
        /** @type {?} */
        const changes = {
            hPosition: positions.horizontalPosition,
            vPosition: positions.verticalPosition
        };
        if (positions.style) {
            changes.top = `${positions.style.top}px`;
            // The component can be aligned from the right or from the left, but not from both.
            if (positions.style.left != null) {
                changes.left = `${positions.style.left}px`;
                changes.right = null;
            }
            else if (positions.style.right != null) {
                changes.right = `${positions.style.right}px`;
                changes.left = null;
            }
            if (positions.style.width != null) {
                changes.width = `${positions.style.width}px`;
            }
            if (this.position$.getValue().top == null) {
                // Bypass on the first reposition only to avoid flickering.
                Object.keys(positions.style).forEach(k => (dropdown.style[(/** @type {?} */ (k))] = positions.style[k]));
            }
        }
        this.position$.next(changes);
        this.previousHorizontalPosition = positions.horizontalPosition;
        this.previousVerticalPosition = positions.verticalPosition;
        return changes;
    }
    /**
     * @param {?=} id
     * @return {?}
     */
    initializeId(id) {
        if (id) {
            this.id = this.uniqueId = id;
        }
        else {
            this.uniqueId = generateDropdownId();
            this.id = `ng-dropdown-${this.uniqueId}`;
        }
    }
    /**
     * @return {?}
     */
    createDefaultWormholeOutlet() {
        if (!this.document.getElementById('ng-dropdown-outlet')) {
            /** @type {?} */
            const outlet = this.document.createElement('div');
            outlet.id = 'ng-dropdown-outlet';
            this.document.body.insertBefore(outlet, this.document.body.firstChild);
        }
    }
}
AngularDropdownDirective.decorators = [
    { type: Directive, args: [{
                selector: 'ng-dropdown,[ngDropdown],[ng-dropdown]',
                host: {
                    '[class.render-in-place]': 'renderInPlace',
                    '[class.ng-dropdown]': 'true'
                },
                exportAs: 'ngDropdown'
            },] }
];
AngularDropdownDirective.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: String, decorators: [{ type: Attribute, args: ['id',] }] }
];
AngularDropdownDirective.propDecorators = {
    renderInPlace: [{ type: Input }],
    control: [{ type: ContentChild, args: [AngularDropdownControlDirective,] }],
    calculatePosition: [{ type: Input }],
    calculateInPlacePosition: [{ type: Input }],
    disabled: [{ type: Input }],
    beforeOpen: [{ type: Input }],
    beforeClose: [{ type: Input }],
    verticalPosition: [{ type: Input }],
    horizontalPosition: [{ type: Input }],
    onOpen: [{ type: Output, args: ['open',] }],
    onClose: [{ type: Output, args: ['close',] }],
    dropdownContent: [{ type: ContentChild, args: [forwardRef(() => AngularDropdownContentComponent),] }]
};
if (false) {
    /** @type {?} */
    AngularDropdownDirective.prototype.id;
    /** @type {?} */
    AngularDropdownDirective.prototype.renderInPlace;
    /** @type {?} */
    AngularDropdownDirective.prototype.control;
    /** @type {?} */
    AngularDropdownDirective.prototype.previousVerticalPosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.previousHorizontalPosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.matchTriggerWidth;
    /** @type {?} */
    AngularDropdownDirective.prototype._isOpen$;
    /** @type {?} */
    AngularDropdownDirective.prototype.isOpen$;
    /** @type {?} */
    AngularDropdownDirective.prototype.position$;
    /** @type {?} */
    AngularDropdownDirective.prototype.calculatePosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.calculateInPlacePosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.disabled;
    /** @type {?} */
    AngularDropdownDirective.prototype.beforeOpen;
    /** @type {?} */
    AngularDropdownDirective.prototype.beforeClose;
    /** @type {?} */
    AngularDropdownDirective.prototype.verticalPosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.horizontalPosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.onOpen;
    /** @type {?} */
    AngularDropdownDirective.prototype.onClose;
    /** @type {?} */
    AngularDropdownDirective.prototype.dropdownContent;
    /** @type {?} */
    AngularDropdownDirective.prototype.uniqueId;
    /** @type {?} */
    AngularDropdownDirective.prototype.width;
    /** @type {?} */
    AngularDropdownDirective.prototype.document;
    /** @type {?} */
    AngularDropdownDirective.prototype.reposition;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1kcm9wZG93bi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLWRyb3Bkb3duLyIsInNvdXJjZXMiOlsibGliL2FuZ3VsYXItZHJvcGRvd24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckQsT0FBTyxFQUVMLFNBQVMsRUFDVCxTQUFTLEVBQ1QsTUFBTSxFQUNOLEtBQUssRUFDTCxNQUFNLEVBSU4sWUFBWSxFQUtaLFVBQVUsRUFDWCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFM0MsT0FBTyxFQUFFLCtCQUErQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDdkYsT0FBTyxFQUFFLCtCQUErQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFdkYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLHdCQUF3QixFQUFFLE1BQU0sU0FBUyxDQUFDOzs7O0FBRXRFLG9EQUdDOzs7SUFGQyxtREFBNkI7O0lBQzdCLG1EQUF1Qzs7O0lBR3JDLEdBQUcsR0FBRyxDQUFDOzs7O0FBQ1g7SUFDRSxPQUFPLEdBQUcsRUFBRSxDQUFDO0FBQ2YsQ0FBQzs7OztBQUtELDZDQU9DOzs7SUFOQyw0Q0FBOEM7O0lBQzlDLDRDQUE0Qzs7SUFDNUMsc0NBQTRCOztJQUM1Qix1Q0FBNkI7O0lBQzdCLHlDQUErQjs7SUFDL0Isd0NBQThCOzs7TUFHMUIsNEJBQTRCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNqRCxTQUFTLEVBQUUsSUFBSTtJQUNmLFNBQVMsRUFBRSxJQUFJO0lBQ2YsR0FBRyxFQUFFLElBQUk7SUFDVCxJQUFJLEVBQUUs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ICdyeGpzJztcbmltcG9ydCB7IHNraXAsIGZpcnN0LCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgRGlyZWN0aXZlLFxuICBBdHRyaWJ1dGUsXG4gIEluamVjdCxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgRWxlbWVudFJlZixcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgT25DaGFuZ2VzLFxuICBDb250ZW50Q2hpbGQsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIEV2ZW50RW1pdHRlcixcbiAgUXVlcnlMaXN0LFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBmb3J3YXJkUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5cbmltcG9ydCB7IEFuZ3VsYXJEcm9wZG93bkNvbnRyb2xEaXJlY3RpdmUgfSBmcm9tICcuL2FuZ3VsYXItZHJvcGRvd24tY29udHJvbC5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgQW5ndWxhckRyb3Bkb3duQ29udGVudENvbXBvbmVudCB9IGZyb20gJy4vYW5ndWxhci1kcm9wZG93bi1jb250ZW50LmNvbXBvbmVudCc7XG5cbmltcG9ydCB7IGNhbGN1bGF0ZVBvc2l0aW9uLCBjYWxjdWxhdGVJblBsYWNlUG9zaXRpb24gfSBmcm9tICcuL3V0aWxzJztcblxuZXhwb3J0IGludGVyZmFjZSBBbmd1bGFyRHJvcGRvd25Qb3NpdGlvbkNoYW5nZXMge1xuICB2UG9zaXRpb246ICdhYm92ZScgfCAnYmVsb3cnO1xuICBoUG9zaXRpb246ICdyaWdodCcgfCAnY2VudGVyJyB8ICdsZWZ0Jztcbn1cblxubGV0IF9pZCA9IDE7XG5mdW5jdGlvbiBnZW5lcmF0ZURyb3Bkb3duSWQoKSB7XG4gIHJldHVybiBfaWQrKztcbn1cblxuZXhwb3J0IHR5cGUgVmVydGljYWxQb3NpdGlvbiA9ICdhdXRvJyB8ICdhYm92ZScgfCAnYmVsb3cnO1xuZXhwb3J0IHR5cGUgSG9yaXpvbnRhbFBvc2l0aW9uID0gJ2F1dG8nIHwgJ3JpZ2h0JyB8ICdjZW50ZXInIHwgJ2xlZnQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIERyb3Bkb3duQ29udGVudFBvc2l0aW9uIHtcbiAgcmVhZG9ubHkgaFBvc2l0aW9uOiBIb3Jpem9udGFsUG9zaXRpb24gfCBudWxsO1xuICByZWFkb25seSB2UG9zaXRpb246IFZlcnRpY2FsUG9zaXRpb24gfCBudWxsO1xuICByZWFkb25seSB0b3A6IHN0cmluZyB8IG51bGw7XG4gIHJlYWRvbmx5IGxlZnQ6IHN0cmluZyB8IG51bGw7XG4gIHJlYWRvbmx5IGJvdHRvbTogc3RyaW5nIHwgbnVsbDtcbiAgcmVhZG9ubHkgcmlnaHQ6IHN0cmluZyB8IG51bGw7XG59XG5cbmNvbnN0IEVtcHR5RHJvcGRvd25Db250ZW50UG9zaXRpb24gPSBPYmplY3QuZnJlZXplKHtcbiAgdlBvc2l0aW9uOiBudWxsLFxuICBoUG9zaXRpb246IG51bGwsXG4gIHRvcDogbnVsbCxcbiAgbGVmdDogbnVsbCxcbiAgYm90dG9tOiBudWxsLFxuICByaWdodDogbnVsbFxufSk7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ25nLWRyb3Bkb3duLFtuZ0Ryb3Bkb3duXSxbbmctZHJvcGRvd25dJyxcbiAgaG9zdDoge1xuICAgICdbY2xhc3MucmVuZGVyLWluLXBsYWNlXSc6ICdyZW5kZXJJblBsYWNlJyxcbiAgICAnW2NsYXNzLm5nLWRyb3Bkb3duXSc6ICd0cnVlJ1xuICB9LFxuICBleHBvcnRBczogJ25nRHJvcGRvd24nXG59KVxuZXhwb3J0IGNsYXNzIEFuZ3VsYXJEcm9wZG93bkRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XG4gIGlkPzogc3RyaW5nO1xuXG4gIEBJbnB1dCgpXG4gIHJlbmRlckluUGxhY2UgPSBmYWxzZTtcblxuICBAQ29udGVudENoaWxkKEFuZ3VsYXJEcm9wZG93bkNvbnRyb2xEaXJlY3RpdmUpXG4gIGNvbnRyb2w6IEFuZ3VsYXJEcm9wZG93bkNvbnRyb2xEaXJlY3RpdmUgfCBudWxsID0gbnVsbDtcblxuICBwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb246IFZlcnRpY2FsUG9zaXRpb24gfCBudWxsID0gbnVsbDtcbiAgcHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb246IEhvcml6b250YWxQb3NpdGlvbiB8IG51bGwgPSBudWxsO1xuICBtYXRjaFRyaWdnZXJXaWR0aCA9IGZhbHNlO1xuXG4gIHByaXZhdGUgX2lzT3BlbiQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KGZhbHNlKTtcbiAgaXNPcGVuJCA9IHRoaXMuX2lzT3BlbiQucGlwZShza2lwKDEpKTtcblxuICBwb3NpdGlvbiQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFJlYWRvbmx5PERyb3Bkb3duQ29udGVudFBvc2l0aW9uPj4oXG4gICAgRW1wdHlEcm9wZG93bkNvbnRlbnRQb3NpdGlvblxuICApO1xuXG4gIGdldCBkcm9wZG93bklkKCkge1xuICAgIHJldHVybiBgbmctZHJvcGRvd24tY29udGVudC0ke3RoaXMudW5pcXVlSWR9YDtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIGNhbGN1bGF0ZVBvc2l0aW9uOiBGdW5jdGlvbiA9IGNhbGN1bGF0ZVBvc2l0aW9uO1xuICBASW5wdXQoKVxuICBjYWxjdWxhdGVJblBsYWNlUG9zaXRpb246IEZ1bmN0aW9uID0gY2FsY3VsYXRlSW5QbGFjZVBvc2l0aW9uO1xuXG4gIEBJbnB1dCgpXG4gIGRpc2FibGVkID0gZmFsc2U7XG5cbiAgQElucHV0KClcbiAgYmVmb3JlT3BlbjogKCgpID0+IGJvb2xlYW4gfCBPYnNlcnZhYmxlPGJvb2xlYW4+KSB8IG51bGwgPSBudWxsO1xuXG4gIEBJbnB1dCgpXG4gIGJlZm9yZUNsb3NlOiAoKCkgPT4gYm9vbGVhbiB8IE9ic2VydmFibGU8Ym9vbGVhbj4pIHwgbnVsbCA9IG51bGw7XG5cbiAgQElucHV0KClcbiAgcHVibGljIHZlcnRpY2FsUG9zaXRpb246IFZlcnRpY2FsUG9zaXRpb24gPSAnYXV0byc7XG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBob3Jpem9udGFsUG9zaXRpb246IEhvcml6b250YWxQb3NpdGlvbiA9ICdhdXRvJztcblxuICBAT3V0cHV0KCdvcGVuJylcbiAgb25PcGVuID0gdGhpcy5pc09wZW4kLnBpcGUoZmlsdGVyKG9wZW4gPT4gb3BlbiA9PT0gdHJ1ZSkpO1xuXG4gIEBPdXRwdXQoJ2Nsb3NlJylcbiAgb25DbG9zZSA9IHRoaXMuaXNPcGVuJC5waXBlKGZpbHRlcihvcGVuID0+IG9wZW4gPT09IGZhbHNlKSk7XG5cbiAgZ2V0IHRyaWdnZXJFbGVtZW50KCk6IEhUTUxFbGVtZW50IHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuY29udHJvbCAmJiB0aGlzLmNvbnRyb2wuZWxlbWVudC5uYXRpdmVFbGVtZW50O1xuICB9XG5cbiAgZ2V0IGRyb3Bkb3duRWxlbWVudCgpOiBIVE1MRWxlbWVudCB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuZHJvcGRvd25JZCk7XG4gIH1cblxuICBAQ29udGVudENoaWxkKGZvcndhcmRSZWYoKCkgPT4gQW5ndWxhckRyb3Bkb3duQ29udGVudENvbXBvbmVudCkpXG4gIHByaXZhdGUgZHJvcGRvd25Db250ZW50PzogQW5ndWxhckRyb3Bkb3duQ29udGVudENvbXBvbmVudDtcblxuICBwcml2YXRlIHVuaXF1ZUlkOiBudW1iZXIgfCBzdHJpbmcgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSB3aWR0aDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgZG9jdW1lbnQ6IERvY3VtZW50O1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoRE9DVU1FTlQpIGRvY3VtZW50OiBhbnksIEBBdHRyaWJ1dGUoJ2lkJykgaWQ/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7XG4gICAgdGhpcy5pbml0aWFsaXplSWQoaWQpO1xuICAgIHRoaXMuY3JlYXRlRGVmYXVsdFdvcm1ob2xlT3V0bGV0KCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyh7IGRpc2FibGVkIH06IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoXG4gICAgICBkaXNhYmxlZCAmJlxuICAgICAgZGlzYWJsZWQuZmlyc3RDaGFuZ2UgPT09IGZhbHNlICYmXG4gICAgICBkaXNhYmxlZC5jdXJyZW50VmFsdWUgPT09IHRydWUgJiZcbiAgICAgIGRpc2FibGVkLnByZXZpb3VzVmFsdWUgIT09IHRydWVcbiAgICApIHtcbiAgICAgIHRoaXMuZGlzYWJsZSgpO1xuICAgIH1cbiAgfVxuXG4gIG9wZW4oKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWQgfHwgdGhpcy5faXNPcGVuJC5nZXRWYWx1ZSgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IG9wZW4kID0gb2YodHJ1ZSk7XG5cbiAgICBpZiAodGhpcy5iZWZvcmVPcGVuKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmJlZm9yZU9wZW4oKTtcbiAgICAgIG9wZW4kID0gcmVzdWx0IGluc3RhbmNlb2YgT2JzZXJ2YWJsZSA/IHJlc3VsdCA6IG9mKHJlc3VsdCk7XG4gICAgfVxuXG4gICAgb3BlbiRcbiAgICAgIC5waXBlKFxuICAgICAgICBmaXJzdCgpLFxuICAgICAgICBmaWx0ZXIob3BlbiA9PiBvcGVuID09PSB0cnVlKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLl9pc09wZW4kLm5leHQodHJ1ZSkpO1xuICB9XG5cbiAgY2xvc2Uoc2tpcEZvY3VzID0gZmFsc2UpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5kaXNhYmxlZCB8fCAhdGhpcy5faXNPcGVuJC5nZXRWYWx1ZSgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IGNsb3NlJCA9IG9mKHRydWUpO1xuXG4gICAgaWYgKHRoaXMuYmVmb3JlQ2xvc2UpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYmVmb3JlQ2xvc2UoKTtcbiAgICAgIGNsb3NlJCA9IHJlc3VsdCBpbnN0YW5jZW9mIE9ic2VydmFibGUgPyByZXN1bHQgOiBvZihyZXN1bHQpO1xuICAgIH1cblxuICAgIGNsb3NlJFxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpcnN0KCksXG4gICAgICAgIGZpbHRlcihjbG9zZSA9PiBjbG9zZSA9PT0gdHJ1ZSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtcbiAgICAgICAgICBoUG9zaXRpb246IG51bGwsXG4gICAgICAgICAgdlBvc2l0aW9uOiBudWxsLFxuICAgICAgICAgIHRvcDogbnVsbCxcbiAgICAgICAgICByaWdodDogbnVsbCxcbiAgICAgICAgICBib3R0b206IG51bGwsXG4gICAgICAgICAgbGVmdDogbnVsbCxcbiAgICAgICAgICB3aWR0aDogbnVsbCxcbiAgICAgICAgICBwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb246IG51bGwsXG4gICAgICAgICAgcHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb246IG51bGxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuX2lzT3BlbiQubmV4dChmYWxzZSk7XG5cbiAgICAgICAgaWYgKCFza2lwRm9jdXMpIHtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICB0aGlzLnRyaWdnZXJFbGVtZW50IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgJiZcbiAgICAgICAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnQudGFiSW5kZXggPiAtMVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgdGhpcy50cmlnZ2VyRWxlbWVudC5mb2N1cygpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICB0b2dnbGUoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX2lzT3BlbiQuZ2V0VmFsdWUoKSkge1xuICAgICAgdGhpcy5jbG9zZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9wZW4oKTtcbiAgICB9XG4gIH1cblxuICBkaXNhYmxlKCk6IHZvaWQge1xuICAgIHRoaXMuZGlzYWJsZWQgPSB0cnVlO1xuICAgIHRoaXMuY2xvc2UoKTtcbiAgfVxuXG4gIGVuYWJsZSgpOiB2b2lkIHtcbiAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7XG4gIH1cblxuICByZXBvc2l0aW9uID0gKCk6IEFuZ3VsYXJEcm9wZG93blBvc2l0aW9uQ2hhbmdlcyB8IG51bGwgPT4ge1xuICAgIGlmICghdGhpcy5faXNPcGVuJC5nZXRWYWx1ZSgpKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBkcm9wZG93bkVsZW1lbnQgPSB0aGlzLmRyb3Bkb3duRWxlbWVudDtcbiAgICBpZiAoIWRyb3Bkb3duRWxlbWVudCB8fCAhdGhpcy50cmlnZ2VyRWxlbWVudCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgX2NhbGN1bGF0ZVBvc2l0aW9uID0gdGhpcy5yZW5kZXJJblBsYWNlXG4gICAgICA/IHRoaXMuY2FsY3VsYXRlSW5QbGFjZVBvc2l0aW9uXG4gICAgICA6IHRoaXMuY2FsY3VsYXRlUG9zaXRpb247XG5cbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgaG9yaXpvbnRhbFBvc2l0aW9uOiB0aGlzLmhvcml6b250YWxQb3NpdGlvbixcbiAgICAgIHZlcnRpY2FsUG9zaXRpb246IHRoaXMudmVydGljYWxQb3NpdGlvbixcbiAgICAgIG1hdGNoVHJpZ2dlcldpZHRoOiB0aGlzLm1hdGNoVHJpZ2dlcldpZHRoLFxuICAgICAgcHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb246IHRoaXMucHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb24sXG4gICAgICBwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb246IHRoaXMucHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uXG4gICAgfTtcblxuICAgIGNvbnN0IHBvc2l0aW9uRGF0YSA9IF9jYWxjdWxhdGVQb3NpdGlvbihcbiAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnQsXG4gICAgICBkcm9wZG93bkVsZW1lbnQsXG4gICAgICBvcHRpb25zXG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLmFwcGx5UmVwb3NpdGlvbihcbiAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnQsXG4gICAgICBkcm9wZG93bkVsZW1lbnQsXG4gICAgICBwb3NpdGlvbkRhdGFcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgYXBwbHlSZXBvc2l0aW9uKFxuICAgIHRyaWdnZXI6IEVsZW1lbnQsXG4gICAgZHJvcGRvd246IEhUTUxFbGVtZW50LFxuICAgIHBvc2l0aW9uczogYW55XG4gICk6IEFuZ3VsYXJEcm9wZG93blBvc2l0aW9uQ2hhbmdlcyB7XG4gICAgY29uc3QgY2hhbmdlczogYW55ID0ge1xuICAgICAgaFBvc2l0aW9uOiBwb3NpdGlvbnMuaG9yaXpvbnRhbFBvc2l0aW9uLFxuICAgICAgdlBvc2l0aW9uOiBwb3NpdGlvbnMudmVydGljYWxQb3NpdGlvblxuICAgIH07XG4gICAgaWYgKHBvc2l0aW9ucy5zdHlsZSkge1xuICAgICAgY2hhbmdlcy50b3AgPSBgJHtwb3NpdGlvbnMuc3R5bGUudG9wfXB4YDtcbiAgICAgIC8vIFRoZSBjb21wb25lbnQgY2FuIGJlIGFsaWduZWQgZnJvbSB0aGUgcmlnaHQgb3IgZnJvbSB0aGUgbGVmdCwgYnV0IG5vdCBmcm9tIGJvdGguXG4gICAgICBpZiAocG9zaXRpb25zLnN0eWxlLmxlZnQgIT0gbnVsbCkge1xuICAgICAgICBjaGFuZ2VzLmxlZnQgPSBgJHtwb3NpdGlvbnMuc3R5bGUubGVmdH1weGA7XG4gICAgICAgIGNoYW5nZXMucmlnaHQgPSBudWxsO1xuICAgICAgfSBlbHNlIGlmIChwb3NpdGlvbnMuc3R5bGUucmlnaHQgIT0gbnVsbCkge1xuICAgICAgICBjaGFuZ2VzLnJpZ2h0ID0gYCR7cG9zaXRpb25zLnN0eWxlLnJpZ2h0fXB4YDtcbiAgICAgICAgY2hhbmdlcy5sZWZ0ID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIGlmIChwb3NpdGlvbnMuc3R5bGUud2lkdGggIT0gbnVsbCkge1xuICAgICAgICBjaGFuZ2VzLndpZHRoID0gYCR7cG9zaXRpb25zLnN0eWxlLndpZHRofXB4YDtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnBvc2l0aW9uJC5nZXRWYWx1ZSgpLnRvcCA9PSBudWxsKSB7XG4gICAgICAgIC8vIEJ5cGFzcyBvbiB0aGUgZmlyc3QgcmVwb3NpdGlvbiBvbmx5IHRvIGF2b2lkIGZsaWNrZXJpbmcuXG4gICAgICAgIE9iamVjdC5rZXlzKHBvc2l0aW9ucy5zdHlsZSkuZm9yRWFjaChcbiAgICAgICAgICBrID0+IChkcm9wZG93bi5zdHlsZVtrIGFzIGFueV0gPSBwb3NpdGlvbnMuc3R5bGVba10pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5wb3NpdGlvbiQubmV4dChjaGFuZ2VzKTtcblxuICAgIHRoaXMucHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb24gPSBwb3NpdGlvbnMuaG9yaXpvbnRhbFBvc2l0aW9uO1xuICAgIHRoaXMucHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uID0gcG9zaXRpb25zLnZlcnRpY2FsUG9zaXRpb247XG5cbiAgICByZXR1cm4gY2hhbmdlcztcbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUlkKGlkPzogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKGlkKSB7XG4gICAgICB0aGlzLmlkID0gdGhpcy51bmlxdWVJZCA9IGlkO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnVuaXF1ZUlkID0gZ2VuZXJhdGVEcm9wZG93bklkKCk7XG4gICAgICB0aGlzLmlkID0gYG5nLWRyb3Bkb3duLSR7dGhpcy51bmlxdWVJZH1gO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRGVmYXVsdFdvcm1ob2xlT3V0bGV0KCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmctZHJvcGRvd24tb3V0bGV0JykpIHtcbiAgICAgIGNvbnN0IG91dGxldCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICBvdXRsZXQuaWQgPSAnbmctZHJvcGRvd24tb3V0bGV0JztcbiAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5pbnNlcnRCZWZvcmUob3V0bGV0LCB0aGlzLmRvY3VtZW50LmJvZHkuZmlyc3RDaGlsZCk7XG4gICAgfVxuICB9XG59XG4iXX0=