/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { Component, Input, Host, Inject, forwardRef, NgZone } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { AngularDropdownDirective } from './angular-dropdown.directive';
import { closest, waitForAnimation } from './utils';
/** @type {?} */
var MutationObserver = ((/** @type {?} */ (window))).MutationObserver;
var AngularDropdownContentComponent = /** @class */ (function () {
    function AngularDropdownContentComponent(dropdown, zone, document) {
        var _this = this;
        this.dropdown = dropdown;
        this.zone = zone;
        this.dropdownClass = '';
        this.overlay = false;
        this.hasMoved = false;
        this._animationClass = null;
        this.isTouchDevice = 'ontouchstart' in window;
        this.mutationObserver = null;
        this.destroy$ = new Subject();
        this.transitioningInClass = 'ng-dropdown-content--transitioning-in';
        this.transitionedInClass = 'ng-dropdown-content--transitioned-in';
        this.transitioningOutClass = 'ng-dropdown-content--transitioning-out';
        this.shouldOpen = false;
        this.repositionInZone = function () {
            return _this.zone.run(function () { return _this.dropdown.reposition(); });
        };
        this.handleRootMouseDown = function (e) {
            var target = (/** @type {?} */ (e)).target;
            if (_this.hasMoved ||
                (_this.dropdownElement !== null &&
                    _this.dropdownElement.contains(target)) ||
                (_this.triggerElement !== null && _this.triggerElement.contains(target))) {
                _this.hasMoved = false;
                return;
            }
            /** @type {?} */
            var closestDropdown = closest(target, 'ng-dropdown-content');
            if (closestDropdown !== null) {
                /** @type {?} */
                var trigger = _this.document.querySelector("[aria-controls=" + closestDropdown.getAttribute('id') + "]");
                /** @type {?} */
                var parentDropdown = closest((/** @type {?} */ (trigger)), 'ng-dropdown-content');
                if (parentDropdown !== null &&
                    parentDropdown.getAttribute('id') === _this.dropdown.dropdownId) {
                    _this.hasMoved = false;
                    return;
                }
            }
            _this.dropdown.close(true);
        };
        this.touchStartHandler = function (e) {
            _this.document.body.addEventListener('touchmove', _this.touchMoveHandler, true);
        };
        this.touchMoveHandler = function (e) {
            _this.hasMoved = true;
            _this.document.body.removeEventListener('touchmove', _this.touchMoveHandler, true);
        };
        this.document = document;
    }
    Object.defineProperty(AngularDropdownContentComponent.prototype, "dropdownElement", {
        get: /**
         * @return {?}
         */
        function () {
            return this.dropdown.dropdownElement;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.dropdown.onOpen
            .pipe(takeUntil(this.destroy$))
            .subscribe(function () { return (_this.shouldOpen = true); });
        this.dropdown.onClose
            .pipe(takeUntil(this.destroy$))
            .subscribe(function () { return _this.close(); });
    };
    Object.defineProperty(AngularDropdownContentComponent.prototype, "animationClass", {
        get: /**
         * @return {?}
         */
        function () {
            return this._animationClass;
        },
        set: /**
         * @param {?} className
         * @return {?}
         */
        function (className) {
            if (this.dropdownElement !== null) {
                if (this._animationClass && className !== this._animationClass) {
                    this.dropdownElement.classList.remove(this._animationClass);
                }
                else if (className) {
                    this.dropdownElement.classList.add(className);
                }
            }
            this._animationClass = className;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AngularDropdownContentComponent.prototype, "triggerElement", {
        get: /**
         * @return {?}
         */
        function () {
            return this.dropdown.triggerElement;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.ngAfterViewChecked = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.shouldOpen) {
            this.animationClass = this.transitioningInClass;
            requestAnimationFrame(function () { return _this.open(); });
            this.shouldOpen = false;
        }
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.destroy$.next();
        this.teardownEvents();
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.open = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.document.body.addEventListener('mousedown', this.handleRootMouseDown, true);
        if (this.isTouchDevice) {
            this.document.body.addEventListener('touchstart', this.touchStartHandler, true);
            this.document.body.addEventListener('touchend', this.handleRootMouseDown, true);
        }
        /** @type {?} */
        var changes = this.dropdown.reposition();
        if (!this.dropdown.renderInPlace) {
            this.addGlobalEvents();
            this.startObservingDomMutations();
        }
        else if (changes !== null && changes.vPosition === 'above') {
            this.startObservingDomMutations();
        }
        requestAnimationFrame(function () { return _this.animateIn(); });
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.close = /**
     * @return {?}
     */
    function () {
        this.teardownEvents();
        this.animateOut();
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.animateIn = /**
     * @return {?}
     */
    function () {
        var _this = this;
        waitForAnimation(this.dropdownElement, function () {
            _this.animationClass = _this.transitionedInClass;
        });
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.animateOut = /**
     * @return {?}
     */
    function () {
        if (this.dropdownElement === null) {
            return;
        }
        /** @type {?} */
        var parentElement = this.dropdown.renderInPlace
            ? (/** @type {?} */ ((/** @type {?} */ (this.dropdownElement.parentElement)).parentElement))
            : (/** @type {?} */ (this.dropdownElement.parentElement));
        /** @type {?} */
        var clone = (/** @type {?} */ (this.dropdownElement.cloneNode(true)));
        clone.id = this.dropdownElement.id + "--clone";
        clone.classList.remove(this.transitionedInClass);
        clone.classList.remove(this.transitioningInClass);
        clone.classList.add(this.transitioningOutClass);
        parentElement.appendChild(clone);
        this.animationClass = this.transitioningInClass;
        waitForAnimation(clone, function () { return parentElement.removeChild(clone); });
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.startObservingDomMutations = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (MutationObserver !== undefined) {
            this.mutationObserver = new MutationObserver(function (mutations) {
                if (mutations[0].addedNodes.length ||
                    mutations[0].removedNodes.length) {
                    _this.repositionInZone();
                }
            });
            (/** @type {?} */ (this.mutationObserver)).observe((/** @type {?} */ (this.dropdownElement)), {
                childList: true,
                subtree: true
            });
        }
        else {
            (/** @type {?} */ (this.dropdownElement)).addEventListener('DOMNodeInserted', this.repositionInZone, false);
            (/** @type {?} */ (this.dropdownElement)).addEventListener('DOMNodeRemoved', this.repositionInZone, false);
        }
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.stopObservingDomMutations = /**
     * @return {?}
     */
    function () {
        if (MutationObserver) {
            if (this.mutationObserver) {
                this.mutationObserver.disconnect();
                this.mutationObserver = null;
            }
        }
        else {
            if (this.dropdownElement !== null) {
                this.dropdownElement.removeEventListener('DOMNodeInserted', this.repositionInZone);
                this.dropdownElement.removeEventListener('DOMNodeRemoved', this.repositionInZone);
            }
        }
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.addGlobalEvents = /**
     * @return {?}
     */
    function () {
        window.addEventListener('scroll', this.repositionInZone);
        window.addEventListener('resize', this.repositionInZone);
        window.addEventListener('orientationchange', this.repositionInZone);
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.removeGlobalEvents = /**
     * @return {?}
     */
    function () {
        window.removeEventListener('scroll', this.repositionInZone);
        window.removeEventListener('resize', this.repositionInZone);
        window.removeEventListener('orientationchange', this.repositionInZone);
    };
    /**
     * @return {?}
     */
    AngularDropdownContentComponent.prototype.teardownEvents = /**
     * @return {?}
     */
    function () {
        this.removeGlobalEvents();
        this.stopObservingDomMutations();
        this.document.body.removeEventListener('mousedown', this.handleRootMouseDown, true);
        if (this.isTouchDevice) {
            this.document.body.removeEventListener('touchstart', this.touchStartHandler, true);
            this.document.body.removeEventListener('touchend', this.handleRootMouseDown, true);
        }
    };
    AngularDropdownContentComponent.decorators = [
        { type: Component, args: [{
                    selector: 'ng-dropdown-content,[ng-dropdown-content],[ngDropdownContent]',
                    template: "<ng-container *ngIf=\"dropdown.isOpen$ | async as isOpen\">\n  <ng-container *ngWormhole=\"'#ng-dropdown-outlet'; renderInPlace: dropdown.renderInPlace\">\n    <div *ngIf=\"overlay && isOpen\" class=\"ng-dropdown-overlay\"></div>\n    <div [id]=\"dropdown.dropdownId\"\n        class=\"ng-dropdown-content {{dropdownClass}}\"\n        [style.top]=\"(dropdown.position$ | async)?.top\"\n        [style.right]=\"(dropdown.position$ | async)?.right\"\n        [style.bottom]=\"(dropdown.position$ | async)?.bottom\"\n        [style.left]=\"(dropdown.position$ | async)?.left\"\n        [class.render-in-place]=\"dropdown.renderInPlace\"\n        [class.ng-dropdown-content--above]=\"(dropdown.position$ | async)?.vPosition === 'above'\"\n        [class.ng-dropdown-content--below]=\"(dropdown.position$ | async)?.vPosition === 'below'\"\n        [class.ng-dropdown-content--right]=\"(dropdown.position$ | async)?.hPosition === 'right'\"\n        [class.ng-dropdown-content--center]=\"(dropdown.position$ | async)?.hPosition === 'center'\"\n        [class.ng-dropdown-content--left]=\"(dropdown.position$ | async)?.hPosition === 'left'\">\n      <ng-content></ng-content>\n    </div>\n  </ng-container>\n  <div *ngIf=\"!isOpen\" [id]=\"dropdown.dropdownId\" class=\"ng-dropdown-placeholder\"></div>\n</ng-container>\n",
                    host: {
                        '[class.render-in-place]': 'dropdown.renderInPlace'
                    },
                    styles: [":host{display:none}:host.render-in-place{display:block;position:absolute}"]
                }] }
    ];
    AngularDropdownContentComponent.ctorParameters = function () { return [
        { type: AngularDropdownDirective, decorators: [{ type: Host }, { type: Inject, args: [forwardRef(function () { return AngularDropdownDirective; }),] }] },
        { type: NgZone },
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
    ]; };
    AngularDropdownContentComponent.propDecorators = {
        dropdownClass: [{ type: Input }],
        overlay: [{ type: Input }],
        transitioningInClass: [{ type: Input }],
        transitionedInClass: [{ type: Input }],
        transitioningOutClass: [{ type: Input }]
    };
    return AngularDropdownContentComponent;
}());
export { AngularDropdownContentComponent };
if (false) {
    /** @type {?} */
    AngularDropdownContentComponent.prototype.dropdownClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.overlay;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.hasMoved;
    /** @type {?} */
    AngularDropdownContentComponent.prototype._animationClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.isTouchDevice;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.mutationObserver;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.destroy$;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.transitioningInClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.transitionedInClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.transitioningOutClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.shouldOpen;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.document;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.repositionInZone;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.handleRootMouseDown;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.touchStartHandler;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.touchMoveHandler;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.dropdown;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1kcm9wZG93bi1jb250ZW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItZHJvcGRvd24vIiwic291cmNlcyI6WyJsaWIvYW5ndWxhci1kcm9wZG93bi1jb250ZW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0MsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsSUFBSSxFQUNKLE1BQU0sRUFDTixVQUFVLEVBSVYsTUFBTSxFQUNQLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUzQyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sU0FBUyxDQUFDOztJQUU5QyxnQkFBZ0IsR0FBRyxDQUFDLG1CQUFBLE1BQU0sRUFBTyxDQUFDLENBQUMsZ0JBQWdCO0FBRXpEO0lBb0NFLHlDQUdTLFFBQWtDLEVBQ2pDLElBQVksRUFDRixRQUFhO1FBTGpDLGlCQVFDO1FBTFEsYUFBUSxHQUFSLFFBQVEsQ0FBMEI7UUFDakMsU0FBSSxHQUFKLElBQUksQ0FBUTtRQTdCdEIsa0JBQWEsR0FBRyxFQUFFLENBQUM7UUFHbkIsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUVSLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFDakIsb0JBQWUsR0FBa0IsSUFBSSxDQUFDO1FBQ3RDLGtCQUFhLEdBQVksY0FBYyxJQUFJLE1BQU0sQ0FBQztRQUNsRCxxQkFBZ0IsR0FBNEIsSUFBSSxDQUFDO1FBQ2pELGFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBR3ZDLHlCQUFvQixHQUFHLHVDQUF1QyxDQUFDO1FBRS9ELHdCQUFtQixHQUFHLHNDQUFzQyxDQUFDO1FBRTdELDBCQUFxQixHQUFHLHdDQUF3QyxDQUFDO1FBTXpELGVBQVUsR0FBRyxLQUFLLENBQUM7UUEyRm5CLHFCQUFnQixHQUFHO1lBQ3pCLE9BQUEsS0FBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLEVBQTFCLENBQTBCLENBQUM7UUFBL0MsQ0FBK0MsQ0FBQztRQTBCMUMsd0JBQW1CLEdBQUcsVUFBQyxDQUFRO1lBQzdCLElBQUEsc0NBQU07WUFFZCxJQUNFLEtBQUksQ0FBQyxRQUFRO2dCQUNiLENBQUMsS0FBSSxDQUFDLGVBQWUsS0FBSyxJQUFJO29CQUM1QixLQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDeEMsQ0FBQyxLQUFJLENBQUMsY0FBYyxLQUFLLElBQUksSUFBSSxLQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUN0RTtnQkFDQSxLQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztnQkFDdEIsT0FBTzthQUNSOztnQkFFSyxlQUFlLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxxQkFBcUIsQ0FBQztZQUM5RCxJQUFJLGVBQWUsS0FBSyxJQUFJLEVBQUU7O29CQUN0QixPQUFPLEdBQUcsS0FBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQ3pDLG9CQUFrQixlQUFlLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFHLENBQ3hEOztvQkFDSyxjQUFjLEdBQUcsT0FBTyxDQUFDLG1CQUFBLE9BQU8sRUFBQyxFQUFFLHFCQUFxQixDQUFDO2dCQUMvRCxJQUNFLGNBQWMsS0FBSyxJQUFJO29CQUN2QixjQUFjLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLEtBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUM5RDtvQkFDQSxLQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztvQkFDdEIsT0FBTztpQkFDUjthQUNGO1lBRUQsS0FBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDO1FBOERNLHNCQUFpQixHQUFHLFVBQUMsQ0FBUTtZQUNuQyxLQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FDakMsV0FBVyxFQUNYLEtBQUksQ0FBQyxnQkFBZ0IsRUFDckIsSUFBSSxDQUNMLENBQUM7UUFDSixDQUFDLENBQUM7UUFFTSxxQkFBZ0IsR0FBRyxVQUFDLENBQVE7WUFDbEMsS0FBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7WUFDckIsS0FBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQ3BDLFdBQVcsRUFDWCxLQUFJLENBQUMsZ0JBQWdCLEVBQ3JCLElBQUksQ0FDTCxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBdE5BLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzNCLENBQUM7SUFmRCxzQkFBWSw0REFBZTs7OztRQUEzQjtZQUNFLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUM7UUFDdkMsQ0FBQzs7O09BQUE7Ozs7SUFlRCxrREFBUTs7O0lBQVI7UUFBQSxpQkFRQztRQVBDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTTthQUNqQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUM5QixTQUFTLENBQUMsY0FBTSxPQUFBLENBQUMsS0FBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsRUFBeEIsQ0FBd0IsQ0FBQyxDQUFDO1FBRTdDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTzthQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUM5QixTQUFTLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxLQUFLLEVBQUUsRUFBWixDQUFZLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsc0JBQUksMkRBQWM7Ozs7UUFXbEI7WUFDRSxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7UUFDOUIsQ0FBQzs7Ozs7UUFiRCxVQUFtQixTQUF3QjtZQUN6QyxJQUFJLElBQUksQ0FBQyxlQUFlLEtBQUssSUFBSSxFQUFFO2dCQUNqQyxJQUFJLElBQUksQ0FBQyxlQUFlLElBQUksU0FBUyxLQUFLLElBQUksQ0FBQyxlQUFlLEVBQUU7b0JBQzlELElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7aUJBQzdEO3FCQUFNLElBQUksU0FBUyxFQUFFO29CQUNwQixJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7aUJBQy9DO2FBQ0Y7WUFDRCxJQUFJLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQztRQUNuQyxDQUFDOzs7T0FBQTtJQU1ELHNCQUFJLDJEQUFjOzs7O1FBQWxCO1lBQ0UsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQztRQUN0QyxDQUFDOzs7T0FBQTs7OztJQUVELDREQUFrQjs7O0lBQWxCO1FBQUEsaUJBTUM7UUFMQyxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUM7WUFDaEQscUJBQXFCLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxJQUFJLEVBQUUsRUFBWCxDQUFXLENBQUMsQ0FBQztZQUN6QyxJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztTQUN6QjtJQUNILENBQUM7Ozs7SUFFRCxxREFBVzs7O0lBQVg7UUFDRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN4QixDQUFDOzs7O0lBRUQsOENBQUk7OztJQUFKO1FBQUEsaUJBNkJDO1FBNUJDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUNqQyxXQUFXLEVBQ1gsSUFBSSxDQUFDLG1CQUFtQixFQUN4QixJQUFJLENBQ0wsQ0FBQztRQUVGLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN0QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FDakMsWUFBWSxFQUNaLElBQUksQ0FBQyxpQkFBaUIsRUFDdEIsSUFBSSxDQUNMLENBQUM7WUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FDakMsVUFBVSxFQUNWLElBQUksQ0FBQyxtQkFBbUIsRUFDeEIsSUFBSSxDQUNMLENBQUM7U0FDSDs7WUFFSyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUU7UUFDMUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFO1lBQ2hDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN2QixJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztTQUNuQzthQUFNLElBQUksT0FBTyxLQUFLLElBQUksSUFBSSxPQUFPLENBQUMsU0FBUyxLQUFLLE9BQU8sRUFBRTtZQUM1RCxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztTQUNuQztRQUVELHFCQUFxQixDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsU0FBUyxFQUFFLEVBQWhCLENBQWdCLENBQUMsQ0FBQztJQUNoRCxDQUFDOzs7O0lBRUQsK0NBQUs7OztJQUFMO1FBQ0UsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUNwQixDQUFDOzs7O0lBS08sbURBQVM7OztJQUFqQjtRQUFBLGlCQUlDO1FBSEMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUNyQyxLQUFJLENBQUMsY0FBYyxHQUFHLEtBQUksQ0FBQyxtQkFBbUIsQ0FBQztRQUNqRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7SUFFTyxvREFBVTs7O0lBQWxCO1FBQ0UsSUFBSSxJQUFJLENBQUMsZUFBZSxLQUFLLElBQUksRUFBRTtZQUNqQyxPQUFPO1NBQ1I7O1lBRUssYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYTtZQUMvQyxDQUFDLENBQUMsbUJBQUEsbUJBQUEsSUFBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhLEVBQUMsQ0FBQyxhQUFhLEVBQUM7WUFDcEQsQ0FBQyxDQUFDLG1CQUFBLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFDOztZQUNqQyxLQUFLLEdBQUcsbUJBQUEsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQWU7UUFDakUsS0FBSyxDQUFDLEVBQUUsR0FBTSxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsWUFBUyxDQUFDO1FBQy9DLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ2pELEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQ2xELEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ2hELGFBQWEsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUM7UUFDaEQsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLGNBQU0sT0FBQSxhQUFhLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFoQyxDQUFnQyxDQUFDLENBQUM7SUFDbEUsQ0FBQzs7OztJQWlDTyxvRUFBMEI7OztJQUFsQztRQUFBLGlCQTBCQztRQXpCQyxJQUFJLGdCQUFnQixLQUFLLFNBQVMsRUFBRTtZQUNsQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxVQUFDLFNBQWM7Z0JBQzFELElBQ0UsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNO29CQUM5QixTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFDaEM7b0JBQ0EsS0FBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7aUJBQ3pCO1lBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDSCxtQkFBQSxJQUFJLENBQUMsZ0JBQWdCLEVBQUMsQ0FBQyxPQUFPLENBQUMsbUJBQUEsSUFBSSxDQUFDLGVBQWUsRUFBQyxFQUFFO2dCQUNwRCxTQUFTLEVBQUUsSUFBSTtnQkFDZixPQUFPLEVBQUUsSUFBSTthQUNkLENBQUMsQ0FBQztTQUNKO2FBQU07WUFDTCxtQkFBQSxJQUFJLENBQUMsZUFBZSxFQUFDLENBQUMsZ0JBQWdCLENBQ3BDLGlCQUFpQixFQUNqQixJQUFJLENBQUMsZ0JBQWdCLEVBQ3JCLEtBQUssQ0FDTixDQUFDO1lBQ0YsbUJBQUEsSUFBSSxDQUFDLGVBQWUsRUFBQyxDQUFDLGdCQUFnQixDQUNwQyxnQkFBZ0IsRUFDaEIsSUFBSSxDQUFDLGdCQUFnQixFQUNyQixLQUFLLENBQ04sQ0FBQztTQUNIO0lBQ0gsQ0FBQzs7OztJQUVPLG1FQUF5Qjs7O0lBQWpDO1FBQ0UsSUFBSSxnQkFBZ0IsRUFBRTtZQUNwQixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDekIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNuQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO2FBQzlCO1NBQ0Y7YUFBTTtZQUNMLElBQUksSUFBSSxDQUFDLGVBQWUsS0FBSyxJQUFJLEVBQUU7Z0JBQ2pDLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CLENBQ3RDLGlCQUFpQixFQUNqQixJQUFJLENBQUMsZ0JBQWdCLENBQ3RCLENBQUM7Z0JBQ0YsSUFBSSxDQUFDLGVBQWUsQ0FBQyxtQkFBbUIsQ0FDdEMsZ0JBQWdCLEVBQ2hCLElBQUksQ0FBQyxnQkFBZ0IsQ0FDdEIsQ0FBQzthQUNIO1NBQ0Y7SUFDSCxDQUFDOzs7O0lBRU8seURBQWU7OztJQUF2QjtRQUNFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDekQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN6RCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDdEUsQ0FBQzs7OztJQUVPLDREQUFrQjs7O0lBQTFCO1FBQ0UsTUFBTSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUM1RCxNQUFNLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzVELE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUN6RSxDQUFDOzs7O0lBbUJPLHdEQUFjOzs7SUFBdEI7UUFDRSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUMxQixJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQztRQUNqQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FDcEMsV0FBVyxFQUNYLElBQUksQ0FBQyxtQkFBbUIsRUFDeEIsSUFBSSxDQUNMLENBQUM7UUFFRixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQ3BDLFlBQVksRUFDWixJQUFJLENBQUMsaUJBQWlCLEVBQ3RCLElBQUksQ0FDTCxDQUFDO1lBQ0YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQ3BDLFVBQVUsRUFDVixJQUFJLENBQUMsbUJBQW1CLEVBQ3hCLElBQUksQ0FDTCxDQUFDO1NBQ0g7SUFDSCxDQUFDOztnQkF4UkYsU0FBUyxTQUFDO29CQUNULFFBQVEsRUFBRSwrREFBK0Q7b0JBQ3pFLDZ5Q0FBd0Q7b0JBRXhELElBQUksRUFBRTt3QkFDSix5QkFBeUIsRUFBRSx3QkFBd0I7cUJBQ3BEOztpQkFDRjs7O2dCQVpRLHdCQUF3Qix1QkEwQzVCLElBQUksWUFDSixNQUFNLFNBQUMsVUFBVSxDQUFDLGNBQU0sT0FBQSx3QkFBd0IsRUFBeEIsQ0FBd0IsQ0FBQztnQkFoRHBELE1BQU07Z0RBbURILE1BQU0sU0FBQyxRQUFROzs7Z0NBL0JqQixLQUFLOzBCQUdMLEtBQUs7dUNBU0wsS0FBSztzQ0FFTCxLQUFLO3dDQUVMLEtBQUs7O0lBK1BSLHNDQUFDO0NBQUEsQUF6UkQsSUF5UkM7U0FqUlksK0JBQStCOzs7SUFFMUMsd0RBQ21COztJQUVuQixrREFDZ0I7O0lBRWhCLG1EQUF5Qjs7SUFDekIsMERBQThDOztJQUM5Qyx3REFBMEQ7O0lBQzFELDJEQUF5RDs7SUFDekQsbURBQXVDOztJQUV2QywrREFDK0Q7O0lBQy9ELDhEQUM2RDs7SUFDN0QsZ0VBQ2lFOztJQU1qRSxxREFBMkI7O0lBQzNCLG1EQUEyQjs7SUEwRjNCLDJEQUNrRDs7SUEwQmxELDhEQTZCRTs7SUE4REYsNERBTUU7O0lBRUYsMkRBT0U7O0lBNU5BLG1EQUV5Qzs7SUFDekMsK0NBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBIb3N0LFxuICBJbmplY3QsXG4gIGZvcndhcmRSZWYsXG4gIEFmdGVyVmlld0NoZWNrZWQsXG4gIE9uSW5pdCxcbiAgT25EZXN0cm95LFxuICBOZ1pvbmVcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuaW1wb3J0IHsgQW5ndWxhckRyb3Bkb3duRGlyZWN0aXZlIH0gZnJvbSAnLi9hbmd1bGFyLWRyb3Bkb3duLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBjbG9zZXN0LCB3YWl0Rm9yQW5pbWF0aW9uIH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IE11dGF0aW9uT2JzZXJ2ZXIgPSAod2luZG93IGFzIGFueSkuTXV0YXRpb25PYnNlcnZlcjtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmctZHJvcGRvd24tY29udGVudCxbbmctZHJvcGRvd24tY29udGVudF0sW25nRHJvcGRvd25Db250ZW50XScsXG4gIHRlbXBsYXRlVXJsOiAnLi9hbmd1bGFyLWRyb3Bkb3duLWNvbnRlbnQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9hbmd1bGFyLWRyb3Bkb3duLWNvbnRlbnQuY29tcG9uZW50LmNzcyddLFxuICBob3N0OiB7XG4gICAgJ1tjbGFzcy5yZW5kZXItaW4tcGxhY2VdJzogJ2Ryb3Bkb3duLnJlbmRlckluUGxhY2UnXG4gIH1cbn0pXG5leHBvcnQgY2xhc3MgQW5ndWxhckRyb3Bkb3duQ29udGVudENvbXBvbmVudFxuICBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3Q2hlY2tlZCwgT25EZXN0cm95IHtcbiAgQElucHV0KClcbiAgZHJvcGRvd25DbGFzcyA9ICcnO1xuXG4gIEBJbnB1dCgpXG4gIG92ZXJsYXkgPSBmYWxzZTtcblxuICBwcml2YXRlIGhhc01vdmVkID0gZmFsc2U7XG4gIHByaXZhdGUgX2FuaW1hdGlvbkNsYXNzOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBpc1RvdWNoRGV2aWNlOiBib29sZWFuID0gJ29udG91Y2hzdGFydCcgaW4gd2luZG93O1xuICBwcml2YXRlIG11dGF0aW9uT2JzZXJ2ZXI6IE11dGF0aW9uT2JzZXJ2ZXIgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgQElucHV0KClcbiAgdHJhbnNpdGlvbmluZ0luQ2xhc3MgPSAnbmctZHJvcGRvd24tY29udGVudC0tdHJhbnNpdGlvbmluZy1pbic7XG4gIEBJbnB1dCgpXG4gIHRyYW5zaXRpb25lZEluQ2xhc3MgPSAnbmctZHJvcGRvd24tY29udGVudC0tdHJhbnNpdGlvbmVkLWluJztcbiAgQElucHV0KClcbiAgdHJhbnNpdGlvbmluZ091dENsYXNzID0gJ25nLWRyb3Bkb3duLWNvbnRlbnQtLXRyYW5zaXRpb25pbmctb3V0JztcblxuICBwcml2YXRlIGdldCBkcm9wZG93bkVsZW1lbnQoKTogSFRNTEVsZW1lbnQgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5kcm9wZG93bi5kcm9wZG93bkVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIHNob3VsZE9wZW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBkb2N1bWVudDogRG9jdW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEhvc3QoKVxuICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBBbmd1bGFyRHJvcGRvd25EaXJlY3RpdmUpKVxuICAgIHB1YmxpYyBkcm9wZG93bjogQW5ndWxhckRyb3Bkb3duRGlyZWN0aXZlLFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIGRvY3VtZW50OiBhbnlcbiAgKSB7XG4gICAgdGhpcy5kb2N1bWVudCA9IGRvY3VtZW50O1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5kcm9wZG93bi5vbk9wZW5cbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4gKHRoaXMuc2hvdWxkT3BlbiA9IHRydWUpKTtcblxuICAgIHRoaXMuZHJvcGRvd24ub25DbG9zZVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLmNsb3NlKCkpO1xuICB9XG5cbiAgc2V0IGFuaW1hdGlvbkNsYXNzKGNsYXNzTmFtZTogc3RyaW5nIHwgbnVsbCkge1xuICAgIGlmICh0aGlzLmRyb3Bkb3duRWxlbWVudCAhPT0gbnVsbCkge1xuICAgICAgaWYgKHRoaXMuX2FuaW1hdGlvbkNsYXNzICYmIGNsYXNzTmFtZSAhPT0gdGhpcy5fYW5pbWF0aW9uQ2xhc3MpIHtcbiAgICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSh0aGlzLl9hbmltYXRpb25DbGFzcyk7XG4gICAgICB9IGVsc2UgaWYgKGNsYXNzTmFtZSkge1xuICAgICAgICB0aGlzLmRyb3Bkb3duRWxlbWVudC5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2FuaW1hdGlvbkNsYXNzID0gY2xhc3NOYW1lO1xuICB9XG5cbiAgZ2V0IGFuaW1hdGlvbkNsYXNzKCk6IHN0cmluZyB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLl9hbmltYXRpb25DbGFzcztcbiAgfVxuXG4gIGdldCB0cmlnZ2VyRWxlbWVudCgpOiBFbGVtZW50IHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuZHJvcGRvd24udHJpZ2dlckVsZW1lbnQ7XG4gIH1cblxuICBuZ0FmdGVyVmlld0NoZWNrZWQoKSB7XG4gICAgaWYgKHRoaXMuc2hvdWxkT3Blbikge1xuICAgICAgdGhpcy5hbmltYXRpb25DbGFzcyA9IHRoaXMudHJhbnNpdGlvbmluZ0luQ2xhc3M7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5vcGVuKCkpO1xuICAgICAgdGhpcy5zaG91bGRPcGVuID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy50ZWFyZG93bkV2ZW50cygpO1xuICB9XG5cbiAgb3BlbigpOiB2b2lkIHtcbiAgICB0aGlzLmRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICdtb3VzZWRvd24nLFxuICAgICAgdGhpcy5oYW5kbGVSb290TW91c2VEb3duLFxuICAgICAgdHJ1ZVxuICAgICk7XG5cbiAgICBpZiAodGhpcy5pc1RvdWNoRGV2aWNlKSB7XG4gICAgICB0aGlzLmRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgJ3RvdWNoc3RhcnQnLFxuICAgICAgICB0aGlzLnRvdWNoU3RhcnRIYW5kbGVyLFxuICAgICAgICB0cnVlXG4gICAgICApO1xuICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICd0b3VjaGVuZCcsXG4gICAgICAgIHRoaXMuaGFuZGxlUm9vdE1vdXNlRG93bixcbiAgICAgICAgdHJ1ZVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5kcm9wZG93bi5yZXBvc2l0aW9uKCk7XG4gICAgaWYgKCF0aGlzLmRyb3Bkb3duLnJlbmRlckluUGxhY2UpIHtcbiAgICAgIHRoaXMuYWRkR2xvYmFsRXZlbnRzKCk7XG4gICAgICB0aGlzLnN0YXJ0T2JzZXJ2aW5nRG9tTXV0YXRpb25zKCk7XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VzICE9PSBudWxsICYmIGNoYW5nZXMudlBvc2l0aW9uID09PSAnYWJvdmUnKSB7XG4gICAgICB0aGlzLnN0YXJ0T2JzZXJ2aW5nRG9tTXV0YXRpb25zKCk7XG4gICAgfVxuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMuYW5pbWF0ZUluKCkpO1xuICB9XG5cbiAgY2xvc2UoKTogdm9pZCB7XG4gICAgdGhpcy50ZWFyZG93bkV2ZW50cygpO1xuICAgIHRoaXMuYW5pbWF0ZU91dCgpO1xuICB9XG5cbiAgcHJpdmF0ZSByZXBvc2l0aW9uSW5ab25lID0gKCkgPT5cbiAgICB0aGlzLnpvbmUucnVuKCgpID0+IHRoaXMuZHJvcGRvd24ucmVwb3NpdGlvbigpKTtcblxuICBwcml2YXRlIGFuaW1hdGVJbigpOiB2b2lkIHtcbiAgICB3YWl0Rm9yQW5pbWF0aW9uKHRoaXMuZHJvcGRvd25FbGVtZW50LCAoKSA9PiB7XG4gICAgICB0aGlzLmFuaW1hdGlvbkNsYXNzID0gdGhpcy50cmFuc2l0aW9uZWRJbkNsYXNzO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhbmltYXRlT3V0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmRyb3Bkb3duRWxlbWVudCA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSB0aGlzLmRyb3Bkb3duLnJlbmRlckluUGxhY2VcbiAgICAgID8gdGhpcy5kcm9wZG93bkVsZW1lbnQucGFyZW50RWxlbWVudCEucGFyZW50RWxlbWVudCFcbiAgICAgIDogdGhpcy5kcm9wZG93bkVsZW1lbnQucGFyZW50RWxlbWVudCE7XG4gICAgY29uc3QgY2xvbmUgPSB0aGlzLmRyb3Bkb3duRWxlbWVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgSFRNTEVsZW1lbnQ7XG4gICAgY2xvbmUuaWQgPSBgJHt0aGlzLmRyb3Bkb3duRWxlbWVudC5pZH0tLWNsb25lYDtcbiAgICBjbG9uZS5jbGFzc0xpc3QucmVtb3ZlKHRoaXMudHJhbnNpdGlvbmVkSW5DbGFzcyk7XG4gICAgY2xvbmUuY2xhc3NMaXN0LnJlbW92ZSh0aGlzLnRyYW5zaXRpb25pbmdJbkNsYXNzKTtcbiAgICBjbG9uZS5jbGFzc0xpc3QuYWRkKHRoaXMudHJhbnNpdGlvbmluZ091dENsYXNzKTtcbiAgICBwYXJlbnRFbGVtZW50LmFwcGVuZENoaWxkKGNsb25lKTtcbiAgICB0aGlzLmFuaW1hdGlvbkNsYXNzID0gdGhpcy50cmFuc2l0aW9uaW5nSW5DbGFzcztcbiAgICB3YWl0Rm9yQW5pbWF0aW9uKGNsb25lLCAoKSA9PiBwYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGNsb25lKSk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVJvb3RNb3VzZURvd24gPSAoZTogRXZlbnQpOiB2b2lkID0+IHtcbiAgICBjb25zdCB7IHRhcmdldCB9ID0gZSBhcyBFdmVudCAmIHsgdGFyZ2V0OiBFbGVtZW50IH07XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLmhhc01vdmVkIHx8XG4gICAgICAodGhpcy5kcm9wZG93bkVsZW1lbnQgIT09IG51bGwgJiZcbiAgICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQuY29udGFpbnModGFyZ2V0KSkgfHxcbiAgICAgICh0aGlzLnRyaWdnZXJFbGVtZW50ICE9PSBudWxsICYmIHRoaXMudHJpZ2dlckVsZW1lbnQuY29udGFpbnModGFyZ2V0KSlcbiAgICApIHtcbiAgICAgIHRoaXMuaGFzTW92ZWQgPSBmYWxzZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjbG9zZXN0RHJvcGRvd24gPSBjbG9zZXN0KHRhcmdldCwgJ25nLWRyb3Bkb3duLWNvbnRlbnQnKTtcbiAgICBpZiAoY2xvc2VzdERyb3Bkb3duICE9PSBudWxsKSB7XG4gICAgICBjb25zdCB0cmlnZ2VyID0gdGhpcy5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgICBgW2FyaWEtY29udHJvbHM9JHtjbG9zZXN0RHJvcGRvd24uZ2V0QXR0cmlidXRlKCdpZCcpfV1gXG4gICAgICApO1xuICAgICAgY29uc3QgcGFyZW50RHJvcGRvd24gPSBjbG9zZXN0KHRyaWdnZXIhLCAnbmctZHJvcGRvd24tY29udGVudCcpO1xuICAgICAgaWYgKFxuICAgICAgICBwYXJlbnREcm9wZG93biAhPT0gbnVsbCAmJlxuICAgICAgICBwYXJlbnREcm9wZG93bi5nZXRBdHRyaWJ1dGUoJ2lkJykgPT09IHRoaXMuZHJvcGRvd24uZHJvcGRvd25JZFxuICAgICAgKSB7XG4gICAgICAgIHRoaXMuaGFzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuZHJvcGRvd24uY2xvc2UodHJ1ZSk7XG4gIH07XG5cbiAgcHJpdmF0ZSBzdGFydE9ic2VydmluZ0RvbU11dGF0aW9ucygpOiB2b2lkIHtcbiAgICBpZiAoTXV0YXRpb25PYnNlcnZlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLm11dGF0aW9uT2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigobXV0YXRpb25zOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIG11dGF0aW9uc1swXS5hZGRlZE5vZGVzLmxlbmd0aCB8fFxuICAgICAgICAgIG11dGF0aW9uc1swXS5yZW1vdmVkTm9kZXMubGVuZ3RoXG4gICAgICAgICkge1xuICAgICAgICAgIHRoaXMucmVwb3NpdGlvbkluWm9uZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMubXV0YXRpb25PYnNlcnZlciEub2JzZXJ2ZSh0aGlzLmRyb3Bkb3duRWxlbWVudCEsIHtcbiAgICAgICAgY2hpbGRMaXN0OiB0cnVlLFxuICAgICAgICBzdWJ0cmVlOiB0cnVlXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQhLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICdET01Ob2RlSW5zZXJ0ZWQnLFxuICAgICAgICB0aGlzLnJlcG9zaXRpb25JblpvbmUsXG4gICAgICAgIGZhbHNlXG4gICAgICApO1xuICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQhLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICdET01Ob2RlUmVtb3ZlZCcsXG4gICAgICAgIHRoaXMucmVwb3NpdGlvbkluWm9uZSxcbiAgICAgICAgZmFsc2VcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdG9wT2JzZXJ2aW5nRG9tTXV0YXRpb25zKCk6IHZvaWQge1xuICAgIGlmIChNdXRhdGlvbk9ic2VydmVyKSB7XG4gICAgICBpZiAodGhpcy5tdXRhdGlvbk9ic2VydmVyKSB7XG4gICAgICAgIHRoaXMubXV0YXRpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgICAgIHRoaXMubXV0YXRpb25PYnNlcnZlciA9IG51bGw7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLmRyb3Bkb3duRWxlbWVudCAhPT0gbnVsbCkge1xuICAgICAgICB0aGlzLmRyb3Bkb3duRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgICAgICdET01Ob2RlSW5zZXJ0ZWQnLFxuICAgICAgICAgIHRoaXMucmVwb3NpdGlvbkluWm9uZVxuICAgICAgICApO1xuICAgICAgICB0aGlzLmRyb3Bkb3duRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgICAgICdET01Ob2RlUmVtb3ZlZCcsXG4gICAgICAgICAgdGhpcy5yZXBvc2l0aW9uSW5ab25lXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRHbG9iYWxFdmVudHMoKTogdm9pZCB7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMucmVwb3NpdGlvbkluWm9uZSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMucmVwb3NpdGlvbkluWm9uZSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywgdGhpcy5yZXBvc2l0aW9uSW5ab25lKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlR2xvYmFsRXZlbnRzKCk6IHZvaWQge1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLnJlcG9zaXRpb25JblpvbmUpO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLnJlcG9zaXRpb25JblpvbmUpO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIHRoaXMucmVwb3NpdGlvbkluWm9uZSk7XG4gIH1cblxuICBwcml2YXRlIHRvdWNoU3RhcnRIYW5kbGVyID0gKGU6IEV2ZW50KSA9PiB7XG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAndG91Y2htb3ZlJyxcbiAgICAgIHRoaXMudG91Y2hNb3ZlSGFuZGxlcixcbiAgICAgIHRydWVcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgdG91Y2hNb3ZlSGFuZGxlciA9IChlOiBFdmVudCkgPT4ge1xuICAgIHRoaXMuaGFzTW92ZWQgPSB0cnVlO1xuICAgIHRoaXMuZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgJ3RvdWNobW92ZScsXG4gICAgICB0aGlzLnRvdWNoTW92ZUhhbmRsZXIsXG4gICAgICB0cnVlXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIHRlYXJkb3duRXZlbnRzKCkge1xuICAgIHRoaXMucmVtb3ZlR2xvYmFsRXZlbnRzKCk7XG4gICAgdGhpcy5zdG9wT2JzZXJ2aW5nRG9tTXV0YXRpb25zKCk7XG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAnbW91c2Vkb3duJyxcbiAgICAgIHRoaXMuaGFuZGxlUm9vdE1vdXNlRG93bixcbiAgICAgIHRydWVcbiAgICApO1xuXG4gICAgaWYgKHRoaXMuaXNUb3VjaERldmljZSkge1xuICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAgICd0b3VjaHN0YXJ0JyxcbiAgICAgICAgdGhpcy50b3VjaFN0YXJ0SGFuZGxlcixcbiAgICAgICAgdHJ1ZVxuICAgICAgKTtcbiAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgICAndG91Y2hlbmQnLFxuICAgICAgICB0aGlzLmhhbmRsZVJvb3RNb3VzZURvd24sXG4gICAgICAgIHRydWVcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXX0=