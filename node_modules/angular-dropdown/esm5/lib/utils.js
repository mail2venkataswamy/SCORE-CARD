/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/**
 * @param {?} element
 * @param {?} callback
 * @return {?}
 */
export function waitForAnimation(element, callback) {
    if (element === null) {
        return;
    }
    requestAnimationFrame(function () {
        /** @type {?} */
        var computedStyle = window.getComputedStyle(element);
        if (computedStyle.animationName !== 'none' &&
            computedStyle.animationPlayState === 'running') {
            return once(element, 'animationend', callback);
        }
        callback();
    });
}
/**
 * @param {?} element
 * @param {?} eventName
 * @param {?} listener
 * @return {?}
 */
function once(element, eventName, listener) {
    element.addEventListener(eventName, function listenOnce(e) {
        element.removeEventListener(eventName, listenOnce);
        return listener(e);
    });
}
/** @type {?} */
export var closest = typeof Element != 'undefined' && Element.prototype.closest
    ? function (el, s) { return el.closest(s); }
    : function _closest(self, s) {
        /** @type {?} */
        var matches = (((/** @type {?} */ (self))).document || self.ownerDocument).querySelectorAll(s);
        /** @type {?} */
        var i;
        /** @type {?} */
        var el = self;
        do {
            i = matches.length;
            while (--i >= 0 && matches.item(i) !== el) { }
        } while (i < 0 && (el = el.parentElement));
        return el;
    };
/**
 * @param {?} trigger
 * @param {?} dropdown
 * @param {?} __2
 * @return {?}
 */
export function calculatePosition(trigger, dropdown, _a) {
    var horizontalPosition = _a.horizontalPosition, verticalPosition = _a.verticalPosition, matchTriggerWidth = _a.matchTriggerWidth, previousHorizontalPosition = _a.previousHorizontalPosition, previousVerticalPosition = _a.previousVerticalPosition;
    // Collect information about all the involved DOM elements
    /** @type {?} */
    var scroll = { left: window.pageXOffset, top: window.pageYOffset };
    var _b = trigger.getBoundingClientRect(), triggerLeft = _b.left, triggerTop = _b.top, triggerWidth = _b.width, triggerHeight = _b.height;
    var _c = dropdown.getBoundingClientRect(), dropdownHeight = _c.height, dropdownWidth = _c.width;
    /** @type {?} */
    var viewportWidth = window.innerWidth;
    /** @type {?} */
    var style = {};
    // Calculate drop down width
    dropdownWidth = matchTriggerWidth ? triggerWidth : dropdownWidth;
    if (matchTriggerWidth) {
        style.width = dropdownWidth;
    }
    // Calculate horizontal position
    /** @type {?} */
    var triggerLeftWithScroll = triggerLeft + scroll.left;
    if (horizontalPosition === 'auto') {
        // Calculate the number of visible horizontal pixels if we were to place the
        // dropdown on the left and right
        /** @type {?} */
        var leftVisible = Math.min(viewportWidth, triggerLeft + dropdownWidth) -
            Math.max(0, triggerLeft);
        /** @type {?} */
        var rightVisible = Math.min(viewportWidth, triggerLeft + triggerWidth) -
            Math.max(0, triggerLeft + triggerWidth - dropdownWidth);
        if (dropdownWidth > leftVisible && rightVisible > leftVisible) {
            // If the drop down won't fit left-aligned, and there is more space on the
            // right than on the left, then force right-aligned
            horizontalPosition = 'right';
        }
        else if (dropdownWidth > rightVisible && leftVisible > rightVisible) {
            // If the drop down won't fit right-aligned, and there is more space on
            // the left than on the right, then force left-aligned
            horizontalPosition = 'left';
        }
        else {
            // Keep same position as previous
            horizontalPosition = previousHorizontalPosition || 'left';
        }
    }
    if (horizontalPosition === 'right') {
        style.right = viewportWidth - (triggerLeftWithScroll + triggerWidth);
    }
    else if (horizontalPosition === 'center') {
        style.left = triggerLeftWithScroll + (triggerWidth - dropdownWidth) / 2;
    }
    else {
        style.left = triggerLeftWithScroll;
    }
    // Calculate vertical position
    /** @type {?} */
    var triggerTopWithScroll = triggerTop + scroll.top;
    if (verticalPosition === 'above') {
        style.top = triggerTopWithScroll - dropdownHeight;
    }
    else if (verticalPosition === 'below') {
        style.top = triggerTopWithScroll + triggerHeight;
    }
    else {
        /** @type {?} */
        var viewportBottom = scroll.top + self.window.innerHeight;
        /** @type {?} */
        var enoughRoomBelow = triggerTopWithScroll + triggerHeight + dropdownHeight < viewportBottom;
        /** @type {?} */
        var enoughRoomAbove = triggerTop > dropdownHeight;
        if (previousVerticalPosition === 'below' &&
            !enoughRoomBelow &&
            enoughRoomAbove) {
            verticalPosition = 'above';
        }
        else if (previousVerticalPosition === 'above' &&
            !enoughRoomAbove &&
            enoughRoomBelow) {
            verticalPosition = 'below';
        }
        else if (!previousVerticalPosition) {
            verticalPosition = enoughRoomBelow ? 'below' : 'above';
        }
        else {
            verticalPosition = previousVerticalPosition;
        }
        style.top =
            triggerTopWithScroll +
                (verticalPosition === 'below' ? triggerHeight : -dropdownHeight);
    }
    return { horizontalPosition: horizontalPosition, verticalPosition: verticalPosition, style: style };
}
/**
 * @param {?} trigger
 * @param {?} dropdown
 * @param {?} __2
 * @return {?}
 */
export function calculateInPlacePosition(trigger, dropdown, _a) {
    var horizontalPosition = _a.horizontalPosition, verticalPosition = _a.verticalPosition;
    /** @type {?} */
    var dropdownRect;
    /** @type {?} */
    var positionData = {};
    if (horizontalPosition === 'auto') {
        /** @type {?} */
        var triggerRect = trigger.getBoundingClientRect();
        dropdownRect = dropdown.getBoundingClientRect();
        /** @type {?} */
        var viewportRight = window.pageXOffset + window.innerWidth;
        positionData.horizontalPosition =
            triggerRect.left + dropdownRect.width > viewportRight ? 'right' : 'left';
    }
    if (verticalPosition === 'above') {
        positionData.verticalPosition = verticalPosition;
        dropdownRect = dropdownRect || dropdown.getBoundingClientRect();
        positionData.style = { top: -dropdownRect.height };
    }
    return positionData;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLWRyb3Bkb3duLyIsInNvdXJjZXMiOlsibGliL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE1BQU0sMkJBQ0osT0FBdUIsRUFDdkIsUUFBNEI7SUFFNUIsSUFBSSxPQUFPLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE9BQU87S0FDUjtJQUVELHFCQUFxQixDQUFDOztZQUNkLGFBQWEsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDO1FBRXRELElBQ0UsYUFBYSxDQUFDLGFBQWEsS0FBSyxNQUFNO1lBQ3RDLGFBQWEsQ0FBQyxrQkFBa0IsS0FBSyxTQUFTLEVBQzlDO1lBQ0EsT0FBTyxJQUFJLENBQUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUNoRDtRQUVELFFBQVEsRUFBRSxDQUFDO0lBQ2IsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDOzs7Ozs7O0FBRUQsY0FDRSxPQUFhLEVBQ2IsU0FBaUIsRUFDakIsUUFBMkI7SUFFM0IsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxvQkFBb0IsQ0FBQztRQUN2RCxPQUFPLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRW5ELE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JCLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQzs7QUFFRCxNQUFNLEtBQU8sT0FBTyxHQUNsQixPQUFPLE9BQU8sSUFBSSxXQUFXLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPO0lBQ3hELENBQUMsQ0FBQyxVQUFDLEVBQUUsRUFBRSxDQUFDLElBQUssT0FBQSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFiLENBQWE7SUFDMUIsQ0FBQyxDQUFDLGtCQUFrQixJQUFhLEVBQUUsQ0FBUzs7WUFDbEMsT0FBTyxHQUFHLENBQ2QsQ0FB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O1FBQTNDLDBDQUFrQixFQUFFLHNDQUFnQjs7UUFFbEMsWUFBWTs7UUFDVixZQUFZLEdBQVEsRUFBRTtJQUU1QixJQUFJLGtCQUFrQixLQUFLLE1BQU0sRUFBRTs7WUFDM0IsV0FBVyxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRTtRQUNuRCxZQUFZLEdBQUcsUUFBUSxDQUFDLHFCQUFxQixFQUFFLENBQUM7O1lBQzFDLGFBQWEsR0FBRyxNQUFNLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxVQUFVO1FBQzVELFlBQVksQ0FBQyxrQkFBa0I7WUFDN0IsV0FBVyxDQUFDLElBQUksR0FBRyxZQUFZLENBQUMsS0FBSyxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7S0FDNUU7SUFDRCxJQUFJLGdCQUFnQixLQUFLLE9BQU8sRUFBRTtRQUNoQyxZQUFZLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7UUFDakQsWUFBWSxHQUFHLFlBQVksSUFBSSxRQUFRLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUNoRSxZQUFZLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUFDO0tBQ3BEO0lBQ0QsT0FBTyxZQUFZLENBQUM7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBmdW5jdGlvbiB3YWl0Rm9yQW5pbWF0aW9uKFxuICBlbGVtZW50OiBFbGVtZW50IHwgbnVsbCxcbiAgY2FsbGJhY2s6IChlPzogRXZlbnQpID0+IGFueVxuKTogdm9pZCB7XG4gIGlmIChlbGVtZW50ID09PSBudWxsKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICBjb25zdCBjb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCk7XG5cbiAgICBpZiAoXG4gICAgICBjb21wdXRlZFN0eWxlLmFuaW1hdGlvbk5hbWUgIT09ICdub25lJyAmJlxuICAgICAgY29tcHV0ZWRTdHlsZS5hbmltYXRpb25QbGF5U3RhdGUgPT09ICdydW5uaW5nJ1xuICAgICkge1xuICAgICAgcmV0dXJuIG9uY2UoZWxlbWVudCwgJ2FuaW1hdGlvbmVuZCcsIGNhbGxiYWNrKTtcbiAgICB9XG5cbiAgICBjYWxsYmFjaygpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gb25jZShcbiAgZWxlbWVudDogTm9kZSxcbiAgZXZlbnROYW1lOiBzdHJpbmcsXG4gIGxpc3RlbmVyOiAoZTogRXZlbnQpID0+IGFueVxuKTogdm9pZCB7XG4gIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGZ1bmN0aW9uIGxpc3Rlbk9uY2UoZSkge1xuICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGxpc3Rlbk9uY2UpO1xuXG4gICAgcmV0dXJuIGxpc3RlbmVyKGUpO1xuICB9KTtcbn1cblxuZXhwb3J0IGNvbnN0IGNsb3Nlc3Q6IChlbGVtZW50OiBFbGVtZW50LCBzZWxlY3Rvcjogc3RyaW5nKSA9PiBFbGVtZW50IHwgbnVsbCA9XG4gIHR5cGVvZiBFbGVtZW50ICE9ICd1bmRlZmluZWQnICYmIEVsZW1lbnQucHJvdG90eXBlLmNsb3Nlc3RcbiAgICA/IChlbCwgcykgPT4gZWwuY2xvc2VzdChzKVxuICAgIDogZnVuY3Rpb24gX2Nsb3Nlc3Qoc2VsZjogRWxlbWVudCwgczogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IG1hdGNoZXMgPSAoXG4gICAgICAgICAgKHNlbGYgYXMgYW55KS5kb2N1bWVudCB8fCBzZWxmLm93bmVyRG9jdW1lbnRcbiAgICAgICAgKS5xdWVyeVNlbGVjdG9yQWxsKHMpO1xuICAgICAgICBsZXQgaTtcbiAgICAgICAgbGV0IGVsOiBFbGVtZW50IHwgbnVsbCA9IHNlbGY7XG4gICAgICAgIGRvIHtcbiAgICAgICAgICBpID0gbWF0Y2hlcy5sZW5ndGg7XG4gICAgICAgICAgd2hpbGUgKC0taSA+PSAwICYmIG1hdGNoZXMuaXRlbShpKSAhPT0gZWwpIHt9XG4gICAgICAgIH0gd2hpbGUgKGkgPCAwICYmIChlbCA9IGVsLnBhcmVudEVsZW1lbnQpKTtcbiAgICAgICAgcmV0dXJuIGVsO1xuICAgICAgfTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZVBvc2l0aW9uKFxuICB0cmlnZ2VyOiBFbGVtZW50LFxuICBkcm9wZG93bjogRWxlbWVudCxcbiAge1xuICAgIGhvcml6b250YWxQb3NpdGlvbixcbiAgICB2ZXJ0aWNhbFBvc2l0aW9uLFxuICAgIG1hdGNoVHJpZ2dlcldpZHRoLFxuICAgIHByZXZpb3VzSG9yaXpvbnRhbFBvc2l0aW9uLFxuICAgIHByZXZpb3VzVmVydGljYWxQb3NpdGlvblxuICB9OiBhbnlcbik6IGFueSB7XG4gIC8vIENvbGxlY3QgaW5mb3JtYXRpb24gYWJvdXQgYWxsIHRoZSBpbnZvbHZlZCBET00gZWxlbWVudHNcbiAgY29uc3Qgc2Nyb2xsID0geyBsZWZ0OiB3aW5kb3cucGFnZVhPZmZzZXQsIHRvcDogd2luZG93LnBhZ2VZT2Zmc2V0IH07XG4gIGNvbnN0IHtcbiAgICBsZWZ0OiB0cmlnZ2VyTGVmdCxcbiAgICB0b3A6IHRyaWdnZXJUb3AsXG4gICAgd2lkdGg6IHRyaWdnZXJXaWR0aCxcbiAgICBoZWlnaHQ6IHRyaWdnZXJIZWlnaHRcbiAgfSA9IHRyaWdnZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gIGxldCB7XG4gICAgaGVpZ2h0OiBkcm9wZG93bkhlaWdodCxcbiAgICB3aWR0aDogZHJvcGRvd25XaWR0aFxuICB9ID0gZHJvcGRvd24uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gIGNvbnN0IHZpZXdwb3J0V2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgY29uc3Qgc3R5bGU6IGFueSA9IHt9O1xuXG4gIC8vIENhbGN1bGF0ZSBkcm9wIGRvd24gd2lkdGhcbiAgZHJvcGRvd25XaWR0aCA9IG1hdGNoVHJpZ2dlcldpZHRoID8gdHJpZ2dlcldpZHRoIDogZHJvcGRvd25XaWR0aDtcbiAgaWYgKG1hdGNoVHJpZ2dlcldpZHRoKSB7XG4gICAgc3R5bGUud2lkdGggPSBkcm9wZG93bldpZHRoO1xuICB9XG5cbiAgLy8gQ2FsY3VsYXRlIGhvcml6b250YWwgcG9zaXRpb25cbiAgY29uc3QgdHJpZ2dlckxlZnRXaXRoU2Nyb2xsID0gdHJpZ2dlckxlZnQgKyBzY3JvbGwubGVmdDtcbiAgaWYgKGhvcml6b250YWxQb3NpdGlvbiA9PT0gJ2F1dG8nKSB7XG4gICAgLy8gQ2FsY3VsYXRlIHRoZSBudW1iZXIgb2YgdmlzaWJsZSBob3Jpem9udGFsIHBpeGVscyBpZiB3ZSB3ZXJlIHRvIHBsYWNlIHRoZVxuICAgIC8vIGRyb3Bkb3duIG9uIHRoZSBsZWZ0IGFuZCByaWdodFxuICAgIGNvbnN0IGxlZnRWaXNpYmxlID1cbiAgICAgIE1hdGgubWluKHZpZXdwb3J0V2lkdGgsIHRyaWdnZXJMZWZ0ICsgZHJvcGRvd25XaWR0aCkgLVxuICAgICAgTWF0aC5tYXgoMCwgdHJpZ2dlckxlZnQpO1xuICAgIGNvbnN0IHJpZ2h0VmlzaWJsZSA9XG4gICAgICBNYXRoLm1pbih2aWV3cG9ydFdpZHRoLCB0cmlnZ2VyTGVmdCArIHRyaWdnZXJXaWR0aCkgLVxuICAgICAgTWF0aC5tYXgoMCwgdHJpZ2dlckxlZnQgKyB0cmlnZ2VyV2lkdGggLSBkcm9wZG93bldpZHRoKTtcblxuICAgIGlmIChkcm9wZG93bldpZHRoID4gbGVmdFZpc2libGUgJiYgcmlnaHRWaXNpYmxlID4gbGVmdFZpc2libGUpIHtcbiAgICAgIC8vIElmIHRoZSBkcm9wIGRvd24gd29uJ3QgZml0IGxlZnQtYWxpZ25lZCwgYW5kIHRoZXJlIGlzIG1vcmUgc3BhY2Ugb24gdGhlXG4gICAgICAvLyByaWdodCB0aGFuIG9uIHRoZSBsZWZ0LCB0aGVuIGZvcmNlIHJpZ2h0LWFsaWduZWRcbiAgICAgIGhvcml6b250YWxQb3NpdGlvbiA9ICdyaWdodCc7XG4gICAgfSBlbHNlIGlmIChkcm9wZG93bldpZHRoID4gcmlnaHRWaXNpYmxlICYmIGxlZnRWaXNpYmxlID4gcmlnaHRWaXNpYmxlKSB7XG4gICAgICAvLyBJZiB0aGUgZHJvcCBkb3duIHdvbid0IGZpdCByaWdodC1hbGlnbmVkLCBhbmQgdGhlcmUgaXMgbW9yZSBzcGFjZSBvblxuICAgICAgLy8gdGhlIGxlZnQgdGhhbiBvbiB0aGUgcmlnaHQsIHRoZW4gZm9yY2UgbGVmdC1hbGlnbmVkXG4gICAgICBob3Jpem9udGFsUG9zaXRpb24gPSAnbGVmdCc7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEtlZXAgc2FtZSBwb3NpdGlvbiBhcyBwcmV2aW91c1xuICAgICAgaG9yaXpvbnRhbFBvc2l0aW9uID0gcHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb24gfHwgJ2xlZnQnO1xuICAgIH1cbiAgfVxuICBpZiAoaG9yaXpvbnRhbFBvc2l0aW9uID09PSAncmlnaHQnKSB7XG4gICAgc3R5bGUucmlnaHQgPSB2aWV3cG9ydFdpZHRoIC0gKHRyaWdnZXJMZWZ0V2l0aFNjcm9sbCArIHRyaWdnZXJXaWR0aCk7XG4gIH0gZWxzZSBpZiAoaG9yaXpvbnRhbFBvc2l0aW9uID09PSAnY2VudGVyJykge1xuICAgIHN0eWxlLmxlZnQgPSB0cmlnZ2VyTGVmdFdpdGhTY3JvbGwgKyAodHJpZ2dlcldpZHRoIC0gZHJvcGRvd25XaWR0aCkgLyAyO1xuICB9IGVsc2Uge1xuICAgIHN0eWxlLmxlZnQgPSB0cmlnZ2VyTGVmdFdpdGhTY3JvbGw7XG4gIH1cblxuICAvLyBDYWxjdWxhdGUgdmVydGljYWwgcG9zaXRpb25cbiAgY29uc3QgdHJpZ2dlclRvcFdpdGhTY3JvbGwgPSB0cmlnZ2VyVG9wICsgc2Nyb2xsLnRvcDtcbiAgaWYgKHZlcnRpY2FsUG9zaXRpb24gPT09ICdhYm92ZScpIHtcbiAgICBzdHlsZS50b3AgPSB0cmlnZ2VyVG9wV2l0aFNjcm9sbCAtIGRyb3Bkb3duSGVpZ2h0O1xuICB9IGVsc2UgaWYgKHZlcnRpY2FsUG9zaXRpb24gPT09ICdiZWxvdycpIHtcbiAgICBzdHlsZS50b3AgPSB0cmlnZ2VyVG9wV2l0aFNjcm9sbCArIHRyaWdnZXJIZWlnaHQ7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgdmlld3BvcnRCb3R0b20gPSBzY3JvbGwudG9wICsgc2VsZi53aW5kb3cuaW5uZXJIZWlnaHQ7XG4gICAgY29uc3QgZW5vdWdoUm9vbUJlbG93ID1cbiAgICAgIHRyaWdnZXJUb3BXaXRoU2Nyb2xsICsgdHJpZ2dlckhlaWdodCArIGRyb3Bkb3duSGVpZ2h0IDwgdmlld3BvcnRCb3R0b207XG4gICAgY29uc3QgZW5vdWdoUm9vbUFib3ZlID0gdHJpZ2dlclRvcCA+IGRyb3Bkb3duSGVpZ2h0O1xuXG4gICAgaWYgKFxuICAgICAgcHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uID09PSAnYmVsb3cnICYmXG4gICAgICAhZW5vdWdoUm9vbUJlbG93ICYmXG4gICAgICBlbm91Z2hSb29tQWJvdmVcbiAgICApIHtcbiAgICAgIHZlcnRpY2FsUG9zaXRpb24gPSAnYWJvdmUnO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb24gPT09ICdhYm92ZScgJiZcbiAgICAgICFlbm91Z2hSb29tQWJvdmUgJiZcbiAgICAgIGVub3VnaFJvb21CZWxvd1xuICAgICkge1xuICAgICAgdmVydGljYWxQb3NpdGlvbiA9ICdiZWxvdyc7XG4gICAgfSBlbHNlIGlmICghcHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uKSB7XG4gICAgICB2ZXJ0aWNhbFBvc2l0aW9uID0gZW5vdWdoUm9vbUJlbG93ID8gJ2JlbG93JyA6ICdhYm92ZSc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZlcnRpY2FsUG9zaXRpb24gPSBwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb247XG4gICAgfVxuICAgIHN0eWxlLnRvcCA9XG4gICAgICB0cmlnZ2VyVG9wV2l0aFNjcm9sbCArXG4gICAgICAodmVydGljYWxQb3NpdGlvbiA9PT0gJ2JlbG93JyA/IHRyaWdnZXJIZWlnaHQgOiAtZHJvcGRvd25IZWlnaHQpO1xuICB9XG5cbiAgcmV0dXJuIHsgaG9yaXpvbnRhbFBvc2l0aW9uLCB2ZXJ0aWNhbFBvc2l0aW9uLCBzdHlsZSB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlSW5QbGFjZVBvc2l0aW9uKFxuICB0cmlnZ2VyOiBFbGVtZW50LFxuICBkcm9wZG93bjogRWxlbWVudCxcbiAgeyBob3Jpem9udGFsUG9zaXRpb24sIHZlcnRpY2FsUG9zaXRpb24gfTogYW55XG4pIHtcbiAgbGV0IGRyb3Bkb3duUmVjdDtcbiAgY29uc3QgcG9zaXRpb25EYXRhOiBhbnkgPSB7fTtcblxuICBpZiAoaG9yaXpvbnRhbFBvc2l0aW9uID09PSAnYXV0bycpIHtcbiAgICBjb25zdCB0cmlnZ2VyUmVjdCA9IHRyaWdnZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgZHJvcGRvd25SZWN0ID0gZHJvcGRvd24uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3Qgdmlld3BvcnRSaWdodCA9IHdpbmRvdy5wYWdlWE9mZnNldCArIHdpbmRvdy5pbm5lcldpZHRoO1xuICAgIHBvc2l0aW9uRGF0YS5ob3Jpem9udGFsUG9zaXRpb24gPVxuICAgICAgdHJpZ2dlclJlY3QubGVmdCArIGRyb3Bkb3duUmVjdC53aWR0aCA+IHZpZXdwb3J0UmlnaHQgPyAncmlnaHQnIDogJ2xlZnQnO1xuICB9XG4gIGlmICh2ZXJ0aWNhbFBvc2l0aW9uID09PSAnYWJvdmUnKSB7XG4gICAgcG9zaXRpb25EYXRhLnZlcnRpY2FsUG9zaXRpb24gPSB2ZXJ0aWNhbFBvc2l0aW9uO1xuICAgIGRyb3Bkb3duUmVjdCA9IGRyb3Bkb3duUmVjdCB8fCBkcm9wZG93bi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBwb3NpdGlvbkRhdGEuc3R5bGUgPSB7IHRvcDogLWRyb3Bkb3duUmVjdC5oZWlnaHQgfTtcbiAgfVxuICByZXR1cm4gcG9zaXRpb25EYXRhO1xufVxuIl19